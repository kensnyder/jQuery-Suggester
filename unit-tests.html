<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>jquery.suggester.js Unit Tests</title>
	<script src="./assets/js/jquery-1.8.0.min.js"></script>
	<script src="./assets/js/qunit-1.10.0.js"></script>
	<script src="./jquery.suggester.js"></script>
	<script src="./assets/js/test-fixtures.js"></script>
	<script src="./assets/js/test-helpers.js"></script>
	<link rel="stylesheet" href="./assets/css/qunit-1.10.0.css" />
</head>
<body>
<div id="qunit"></div>
<script>
(function($) { "use strict";
	// shared vars
	var $form, $input;
	var config = {
		// setup a test form
		setup: function() {
			$('<form class="sugg"><input type="text" name="suggestable" value="" /></form>').appendTo(document.body);
			$form = $('.sugg');
			$input = $('.sugg input');
		},
		// teardown the form
		teardown: function() {
			$form.remove();
			$('.sugg-list').remove();
		}
	};	
	// sample data
	module('Adding Tags', config);
	test("Original element is not visible", function() {
		$input.suggester();
		strictEqual($input.is(':visible'), false);
	});
	test("Form has new text input", function() {
		$input.suggester();
		strictEqual($form.find('input[type=text]:visible').length, 1);
	});
	test("add() an arbitrary item", function() {
		$input.suggester();
		$input.suggester('add', 100, 'Custom');
		strictEqual($form.find('input[type=hidden]').val(), '100');
		strictEqual($form.find('.sugg-label').html(), 'Custom');
	});	
	test("addId()", function() {
		$input.suggester({data:fixtures.planets});
		var $tag = $input.suggester('addId', 1);
		strictEqual($tag.attr('data-id'), '1');
		strictEqual($tag.attr('data-label'), 'Sun');
		strictEqual($form.find('input[type=hidden]').val(), '1');
		strictEqual($form.find('.sugg-label').html(), 'Sun');
	});
	test("addTag()", function() {
		$input.suggester({data:fixtures.planets});
		var $tag = $input.suggester('addTag', 'Pluto');
		strictEqual($tag.attr('data-id'), '11');
		strictEqual($tag.attr('data-label'), 'Pluto');
		strictEqual($form.find('input[type=hidden]').val(), '11');
		strictEqual($form.find('.sugg-label').html(), 'Pluto');
	});	
	test("Add by typing", function() {
		var sugg = $input.suggester({data:fixtures.planets}).suggester('getInstance');
		sugg.$input.val('Mars');
		sendKey(sugg, ',');
		strictEqual($form.find('input[type=hidden]').val(), '5');
		strictEqual($form.find('.sugg-label').html(), 'Mars');	
		strictEqual(sugg.$input.val(), '');	
	});
	test("Add by typing custom", function() {
		var sugg = $input.suggester({data:fixtures.planets}).suggester('getInstance');
		sugg.$input.val('Custom');
		sendKey(sugg, ',');
		strictEqual($form.find('input[type=hidden]').val(), 'Custom');
		strictEqual($form.find('.sugg-label').html(), 'Custom');		
		strictEqual(sugg.$input.val(), '');	
	});
	test("Original input value properly populated", function() {
		var sugg = $input.suggester({data:fixtures.planets}).suggester('getInstance');
		sugg.$input.val('Custom');
		sendKey(sugg, ',');
		sugg.$input.val('lname, fname');
		sendKey(sugg, ',');
		sugg.$input.val('doe, john');
		sendKey(sugg, ',');
		strictEqual($form.find('.sugg-label').length, 3);
		strictEqual($input.val(), 'Custom,lname\\, fname,doe\\, john');
	});
	test("addId() then removeId()", function() {
		$input.suggester({data:fixtures.planets});
		var $tag = $input.suggester('addId', 1);
		strictEqual($tag.attr('data-id'), '1');
		strictEqual($tag.attr('data-label'), 'Sun');
		strictEqual($form.find('input[type=hidden]').val(), '1');
		strictEqual($form.find('.sugg-label').text(), 'Sun');
		$input.suggester('removeId', 1);
		strictEqual($form.find('input[type=hidden]').length, 0);
		strictEqual($form.find('.sugg-label').length, 0);
	});	
	test("addId() then removeLabel()", function() {
		$input.suggester({data:fixtures.planets});
		var $tag = $input.suggester('addId', 7);
		strictEqual($tag.attr('data-id'), '7');
		strictEqual($tag.attr('data-label'), 'Jupiter');
		strictEqual($form.find('input[type=hidden]').val(), '7');
		strictEqual($form.find('.sugg-label').text(), 'Jupiter');
		$input.suggester('removeLabel', 'Jupiter');
		strictEqual($form.find('input[type=hidden]').length, 0);
		strictEqual($form.find('.sugg-label').length, 0);
	});	
	test("addTag() then removeLabel()", function() {
		$input.suggester({data:fixtures.planets});
		var $tag = $input.suggester('addTag', 'Earth');
		strictEqual($tag.attr('data-id'), '4');
		strictEqual($tag.attr('data-label'), 'Earth');
		strictEqual($form.find('input[type=hidden]').val(), '4');
		strictEqual($form.find('.sugg-label').text(), 'Earth');
		$input.suggester('removeLabel', 'Earth');
		strictEqual($form.find('input[type=hidden]').length, 0);
		strictEqual($form.find('.sugg-label').length, 0);
	});	
	test("addTag() with custom then removeLabel()", function() {
		$input.suggester({data:fixtures.planets});
		var $tag = $input.suggester('addTag', 'Custom');
		strictEqual($tag.attr('data-id'), '');
		strictEqual($tag.attr('data-label'), 'Custom');
		strictEqual($form.find('input[type=hidden]').val(), 'Custom');
		strictEqual($form.find('.sugg-label').text(), 'Custom');
		$input.suggester('removeLabel', 'Custom');
		strictEqual($form.find('input[type=hidden]').length, 0);
		strictEqual($form.find('.sugg-label').length, 0);
	});	
	test("addId() then remove by delete key", function() {
		var sugg = $input.suggester({data:fixtures.planets}).suggester('getInstance');
		var $tag = sugg.addId(1);
		sendKeys(sugg, ['BACKSPACE']);
		strictEqual($tag.hasClass('sugg-focused'), true);
		sendKeys(sugg, ['BACKSPACE']);
		strictEqual($form.find('input[type=hidden]').length, 0);
		strictEqual($form.find('.sugg-label').length, 0);
	});
	test("addId() then click to select", function() {
		var sugg = $input.suggester({data:fixtures.planets}).suggester('getInstance');
		var $tag = sugg.addId(1);
		$tag.trigger({type: 'click'});
		strictEqual($tag.hasClass('sugg-focused'), true);
	});	
	test("addId() then remove by clicking `X`", function() {
		var sugg = $input.suggester({data:fixtures.planets}).suggester('getInstance');
		var $tag = sugg.addId(2);
		$tag.find('.sugg-remove').trigger({type: 'click'});
		strictEqual($form.find('input[type=hidden]').length, 0);
		strictEqual($form.find('.sugg-label').length, 0);
	});
	test("addId() then click to select, then delete key", function() {
		expect(2);
		var sugg = $input.suggester({data:fixtures.planets}).suggester('getInstance');
		var $tag = sugg.addId(3);
		$tag.trigger({type: 'click'});
		sendKey(document, 'DELETE');
		strictEqual($form.find('input[type=hidden]').length, 0);
		strictEqual($form.find('.sugg-label').length, 0);		
	});
	asyncTest("Placeholders", function() {
		expect(2);
		var sugg = $input.suggester({placeholder:'Enter tags...'}).suggester('getInstance');
		strictEqual(sugg.$input.val(), sugg.options.placeholder);
		sugg.focus();
		setTimeout(function() {
			strictEqual(sugg.$input.val(), '');
			start();
		}, 1);
	});		
		
	module('Suggestions', config);
	asyncTest("Too short for suggestion", function() {
		expect(1);
		var sugg = $input.suggester({data:fixtures.planets,minChars:3,keyDelay:0}).suggester('getInstance');
		sendKeys(sugg, ['J','u']);
		setTimeout(function() {
			strictEqual($form.find('.sugg-item').length, 0);
			start();
		}, 1);
	});		
	asyncTest("1 then 2 letters", function() {
		expect(5);
		var sugg = $input.suggester({data:fixtures.planets,minChars:1,keyDelay:0}).suggester('getInstance');
		sendKeys(sugg, ['O']);
		setTimeout(function() {
			strictEqual($('.sugg-item').length, 2);
			strictEqual($('.sugg-item').eq(0).text(), 'Asteroid Belt');
			strictEqual($('.sugg-item').eq(1).text(), 'Pluto');		
			start();
			sendKeys(sugg, ['i']);
			setTimeout(function() {
				strictEqual($('.sugg-item').length, 1);
				strictEqual($('.sugg-item').eq(0).text(), 'Asteroid Belt');
			}, 1);
		}, 1);
	});
	asyncTest("Close by clicking document", function() {
		expect(3);
		var sugg = new $.Suggester($input, {data:fixtures.planets,minChars:1,keyDelay:0});
		sendKeys(sugg, ['V','e','n','u']);
		setTimeout(function() {
			strictEqual($('.sugg-item').length, 1);
			strictEqual($('.sugg-item').eq(0).text(), 'Venus');
			start();
			$(document).trigger({
				type: "click",
				target: document.body
			});
			strictEqual($('.sugg-list:visible').length, 0);
		}, 1);
	});
	asyncTest("Close by Esc key", function() {
		expect(3);
		var sugg = new $.Suggester($input, {data:fixtures.planets,minChars:1,keyDelay:0});
		sendKeys(sugg, ['V','e','n','u']);
		setTimeout(function() {
			strictEqual($('.sugg-item').length, 1);
			strictEqual($('.sugg-item').eq(0).text(), 'Venus');
			start();
			sugg.$input.trigger({
				type: 'keydown',
				which: 27
			});
			strictEqual($('.sugg-list:visible').length, 0);
		}, 1);
	});
	asyncTest("Navigate using arrows", function() {
		expect(9);
		var sugg = new $.Suggester($input, {data:fixtures.planets,minChars:1,keyDelay:0});
		sendKeys(sugg, ['e','r']);
		setTimeout(function() {
			strictEqual($('.sugg-item').length, 4);
			strictEqual($('.sugg-item').eq(0).text(), 'Mercury');
			strictEqual($('.sugg-item').eq(1).text(), 'Asteroid Belt');
			strictEqual($('.sugg-item').eq(2).text(), 'Jupiter');
			strictEqual($('.sugg-item').eq(3).text(), 'Eres');
			start();
			sendKeys(sugg, ['DOWN']);
			setTimeout(function() {
				strictEqual($('.sugg-item:visible').eq(0).hasClass('sugg-selected'), true);
				strictEqual($('.sugg-item:visible').eq(1).hasClass('sugg-selected'), false);
				strictEqual($('.sugg-item:visible').eq(2).hasClass('sugg-selected'), false);
				strictEqual($('.sugg-item:visible').eq(3).hasClass('sugg-selected'), false);
			}, 1);
		}, 1);
	});
	asyncTest("Navigate using hover", function() {
		expect(9);
		var sugg = new $.Suggester($input, {data:fixtures.planets,minChars:1,keyDelay:0});
		sendKeys(sugg, ['e','r']);
		setTimeout(function() {
			strictEqual($('.sugg-item').length, 4);
			strictEqual($('.sugg-item').eq(0).text(), 'Mercury');
			strictEqual($('.sugg-item').eq(1).text(), 'Asteroid Belt');
			strictEqual($('.sugg-item').eq(2).text(), 'Jupiter');
			strictEqual($('.sugg-item').eq(3).text(), 'Eres');
			start();
			$('.sugg-item').eq(2).trigger({
				type: 'mouseover'
			});			
			strictEqual($('.sugg-item:visible').eq(0).hasClass('sugg-selected'), false);
			strictEqual($('.sugg-item:visible').eq(1).hasClass('sugg-selected'), false);
			strictEqual($('.sugg-item:visible').eq(2).hasClass('sugg-selected'), true);
			strictEqual($('.sugg-item:visible').eq(3).hasClass('sugg-selected'), false);
		}, 1);
	});
	asyncTest("Add via click on suggestion", function() {
		expect(7);
		var sugg = new $.Suggester($input, {data:fixtures.planets,minChars:1,keyDelay:0});
		sendKeys(sugg, ['a','r']);
		setTimeout(function() {
			strictEqual($('.sugg-item').length, 2);
			strictEqual($('.sugg-item').eq(0).text(), 'Earth');
			strictEqual($('.sugg-item').eq(1).text(), 'Mars');
			start();
			$('.sugg-item').eq(1).trigger({
				type: 'click'
			});		
			strictEqual($('.sugg-item:visible').length, 0);
			strictEqual($form.find('.sugg-label').html(), 'Mars');
			strictEqual($form.find('input[type=hidden]').val(), '5');
			strictEqual($input.val(), 'Mars');
		}, 1);
	});
	asyncTest("Don't suggest an item that was already added", function() {
		expect(2);
		var sugg = new $.Suggester($input, {data:fixtures.planets,minChars:1,keyDelay:0});
		sugg.addTag('Earth');
		sendKeys(sugg, ['a','r']);
		setTimeout(function() {
			strictEqual($('.sugg-item').length, 1);
			strictEqual($('.sugg-item').eq(0).text(), 'Mars');
			start();
		}, 1);
	});	
	asyncTest("Set options.matchAt to 0 to match at beginning of word", function() {
		expect(3);
		var sugg = new $.Suggester($input, {data:fixtures.planets,minChars:1,keyDelay:0,matchAt:0});
		sendKeys(sugg, ['e']);
		setTimeout(function() {
			strictEqual($('.sugg-item').length, 2);
			strictEqual($('.sugg-item').eq(0).text(), 'Earth');
			strictEqual($('.sugg-item').eq(1).text(), 'Eres');
			start();
		}, 1);
	});	
	
}(jQuery, QUnit));
</script>
</body>
</html>
