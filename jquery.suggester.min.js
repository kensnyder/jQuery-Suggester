 /*
 * Suggester v1.0pre: Copyright 2012 Ken Snyder
 * GitHub: https://github.com/kensnyder/jQuery-Suggester
 * MIT Licence: http://www.opensource.org/licenses/mit-license.php
 */
;(function(a){if(typeof define==="function"&&define.amd){define(["jquery"],a)}else{a(jQuery)}}(function(b){"use strict";var d=b(document);b.Suggester=function(){if(arguments[0]==b.Suggester.doSubclass){return}this.initialize.apply(this,Array.prototype.slice.call(arguments))};b.Suggester.defaultOptions={data:false,valueProperty:"value",labelProperty:"value",searchProperties:["value"],matchAt:"anywhere",caseSensitive:false,dataUrl:false,dataType:"json",fly:"down",suggListPosition:"relative",multiselect:true,preventDuplicates:true,omitAlreadyChosenItems:true,minChars:3,keyDelay:400,addOnComma:true,addOnTab:true,submitOnEnter:false,inputSize:"auto",placeholder:"",emptyText:"(Type a comma to create a new item)",prompt:false,maxSuggestions:10,addHiddenInputs:true,hightlightSubstring:true,template:'<div class="sugg-widget"><ul class="sugg-box"><li class="sugg-box-item sugg-tag"><span class="sugg-label">TAG TEXT GOES HERE</span><span class="sugg-remove" title="Click to remove">&times;</span></li><li class="sugg-box-item sugg-input-wrapper"><input type="text" class="sugg-input" value="" /></li></ul><div class="sugg-list-wrapper"><ul class="sugg-list" style="display:none"><li class="sugg-item {record.cssClass}">{record.value}</li><li class="sugg-empty"></li><li class="sugg-prompt"></li></ul></div></div>',listItemTemplate:null};b.Suggester.prototype={initialize:function(g,f){this.$originalInput=b(g);if(this.$originalInput.data("SuggesterInstance")){return this}b.Suggester.instances.push(this);if(this.$originalInput.length==0){return this}this._processOptions(f);this.setData(this.options.data||[]);this.tags=[];this.hiddenName=this.$originalInput.attr("name")+"_tags[]";this.$focusedTag=false;this.$currentItem=false;this._setupPubsub();this._render();this._setupListeners();this.publish("Initialize");return this},destroy:function(){this.$originalInput.insertBefore(this.$widget).show();this.$widget.empty().remove();var f=this;b.each(b.Suggester.instances,function(g){if(f===this){b.Suggester.instances.splice(g,1);return false}});return this.$originalInput},add:function(k,j,i){var g,f,l,h;if(typeof j!="string"){j=k}g=this.publish("BeforeAdd",{value:k,label:j,item:i,record:i?i.data("tag-record"):undefined});if(g.isDefaultPrevented()){this.save();return undefined}if(this.options.preventDuplicates){f=this.getTagIndex(k);if(f>-1){this._spliceTagByIdx(f)}}if(this.options.addHiddenInputs){l=b('<input type="hidden" />').attr("name",this.hiddenName).val(k);this.$widget.append(l)}h=this.$tagTemplate.clone().data("tag-value",g.value).data("tag-label",g.label);this.tags.push({$tag:h,$hidden:l,value:g.value,label:g.label});if(this.options.multiselect){h.find(".sugg-label").html(g.label);this.$inputWrapper.before(h)}else{this.$input.val(g.value)}this.save();this.publish("AfterAdd",{item:i,tag:h,hidden:l,value:g.value,label:g.label});return h},moveSelection:function(g){var i=this.$suggList.find(".sugg-item");var h;if(this.$currentItem&&this.$currentItem.length){h=(g=="down"?this.$currentItem.next():this.$currentItem.prev())}else{h=(g=="down"?i.first():i.last())}var f=this.publish("BeforeMove",{direction:g,current:this.$currentItem,next:h,cancellable:true});if(f.isDefaultPrevented()){return this}if(f.current&&f.current.length){this.deselectItem(f.current)}if(f.next&&f.next.length){this.selectItem(f.next)}this.$currentItem=f.next;this.publish("AfterMove",{direction:g,last:f.current,current:this.$currentItem});return this},selectItem:function(f){f.addClass("sugg-selected");return this},deselectItem:function(f){f.removeClass("sugg-selected");return this},deselectAllItems:function(){this.$suggList.find(".sugg-item").removeClass("sugg-selected");this.$currentItem=null;return this},suggest:function(f){this._text=f;if(this.options.dataUrl){this.fetchResults(f)}else{this.handleSuggestions(this.getResults(f))}},addData:function(j){var h,f,g;if(j.length>0&&typeof j[0]!="object"){for(h=0,f=j.length;h<f;h++){g={};g[this.options.valueProperty]=""+j[h];this.data.push(g)}}else{this.data=this.data.concat(j)}return this},setData:function(f){this.data=[];this.addData(f);return this},getData:function(){return this.data},setFlyDirection:function(f){if(f=="up"){this.$suggListWrapper.insertBefore(this.$box);this.$widget.removeClass("sugg-fly-down").addClass("sugg-fly-up")}else{if(f=="down"){this.$suggListWrapper.insertAfter(this.$box);this.$widget.addClass("sugg-fly-down").removeClass("sugg-fly-up")}}return this},focusTag:function(f){this.unfocusTag();this.$focusedTag=f.addClass("sugg-focused");d.keydown(this.removeFocusedTag).click(this.unfocusTag);return this},unfocusTag:function(){d.unbind("keydown",this.removeFocusedTag).unbind("click",this.unfocusTag);if(this.$focusedTag){this.$focusedTag.removeClass("sugg-focused")}this.$focusedTag=null;return this},removeFocusedTag:function(f){if(f&&f.which&&(f.which==8||f.which==46)){if(this.$focusedTag){this.remove(this.$focusedTag)}f.preventDefault()}this.unfocusTag();return this},remove:function(g){var f,h,i;if(typeof g.nodeType=="number"&&typeof g.style=="object"){g=b(g)}if(g instanceof b){h=g.data("tag-value")}else{h=g;g=false;b.each(this.tags,function(){if(h==this.value){g=this.$tag;return false}})}f=this.publish("BeforeRemove",{tag:g,value:h,cancellable:true});if(f.isDefaultPrevented()){return this}i=this._spliceTag(f.value);this.publish("AfterRemove",{tag:f.tag,value:h,removed:i});return this},findRecord:function(j){var g,h,f;f={};g=false;if(!this.options.caseSensitive){j=j.toLowerCase()}h=this;try{b.each(this.getData(),function(k,l){b.each(h.options.searchProperties,function(){var m=""+(l[this]||"");if(!h.options.caseSensitive){m=m.toLowerCase()}if(m==j){g=l;throw f}})})}catch(i){if(i!==f){throw i}}return g},suggestIfNeeded:function(){var f=this.$input.val();if(f.length>=this.options.minChars){this.suggest(f)}else{if(this.options.prompt){this.showPrompt()}else{this.closeSuggestBox()}}return this},showPrompt:function(){if(!this.$prompt){return this}this.$suggList.html("").append(this.$prompt);this.openSuggestBox();this.$widget.addClass("sugg-prompt-shown");return this},showEmptyText:function(){if(!this.$empty){return this}this.$suggList.html("").append(this.$empty);this.openSuggestBox();this.$widget.addClass("sugg-empty-shown");return this},fetchResults:function(h){this._searchTerm=h;var g={context:this,url:this.options.dataUrl.replace("%s",h)};if(this.options.dataType.toLowerCase()=="json"){g.dataType="json"}else{if(this.options.dataType.toLowerCase()=="jsonp"){g.dataType="jsonp";g.url=g.url.replace("%s","?")}else{throw new Error('jQuery.Suggester#fetchResults: options.dataType must be "json" or "jsonp".')}}var f=this.publish("BeforeAjax",{settings:g,term:h});f.settings.beforeSend=this._beforeFetch;return b.ajax(f.settings).done(this._afterFetch)},abortFetch:function(){if(this._jqXHR){this._jqXHR.abort()}return this},handleSuggestions:function(g){if(!g||g.length==0){this.showEmptyText();return this}var h=this;h.$suggList.empty();b.each(g,function(){var i=b(h._formatSuggestion(this,h._text));i.data("tag-record",this);h.$suggList.append(i)});var f=this.publish("BeforeSuggest",{text:this._text,cancellable:true});if(f.isDefaultPrevented()){return this}this.openSuggestBox();this.publish("AfterSuggest");return this},isSuggestBoxOpen:function(){return this.$suggList.css("display")!="none"},openSuggestBox:function(){var g,j,i,f,m,l,k,h=this;if(this.options.suggListPosition=="absolute"){j=b(document.body).offset();m=this.$box.position();if(this.options.fly=="up"){this.$suggList.css("visibility","hidden").show();l=m.top-j.top-this.$box.outerHeight()+this.$box.height()-this.$suggList.outerHeight();this.$suggList.hide().css("visibility","visible")}else{l=m.top-j.top+this.$box.height()}k=m.left-j.left;i=this.$box.outerWidth();this.$suggList.css({top:l+"px",left:k+"px",width:i})}g=this.publish("BeforeOpen",{cancellable:true});if(g.isDefaultPrevented()){return this}this.$widget.addClass("sugg-list-open").removeClass("sugg-prompt-shown").removeClass("sugg-empty-shown");setTimeout(function(){d.bind("click",h._closeOnOutsideClick)},0);this.$suggList.show();this.publish("AfterOpen");return this},closeSuggestBox:function(){d.unbind("click",this._closeOnOutsideClick);var f=this.publish("BeforeClose",{cancellable:true});if(!f.isDefaultPrevented()){this.$suggList.hide();this.$widget.removeClass("sugg-list-open")}this.publish("AfterClose");return this},focus:function(){this.$input[0].focus();return this},getResults:function(j){j=""+j;var f=this.publish("BeforeFilter",{text:j});if(!this.options.caseSensitive){var g=f.text.toLowerCase()}var i=this;var h=[];b.each(this.getData(),function(l,k){if(i.options.omitAlreadyChosenItems&&i.getTagIndex(k[i.options.valueProperty])>-1){return}b.each(i.options.searchProperties,function(){var m=""+(k[this]||"");if(!i.options.caseSensitive){m=m.toLowerCase()}if((i.options.matchAt=="anywhere"&&m.indexOf(g)>-1)||(m.indexOf(g)==i.options.matchAt)||(i.options.matchAt=="end"&&m.indexOf(g)==m.length-g-length)){h.push(k);return false}});if(i.options.maxSuggestions>0&&h.length>=i.options.maxSuggestions){return false}});this.publish("AfterFilter",{text:f.text,results:h});return h},publish:function(g,h){var f=b.Event(g);f.target=this;if(h){b.extend(f,h)}this.trigger(f);return f},getInstance:function(){return this},_processOptions:function(f){this.options=b.extend({},b.Suggester.defaultOptions,f);if(this.options.matchAt=="start"||this.options.matchAt=="beginning"){this.options.matchAt=0}},_render:function(){this.$widget=b(this.options.template);this.publish("BeforeRender");this.$box=this.$widget.find(".sugg-box");this.$tagTemplate=this.$box.find(".sugg-tag").remove();this.$input=this.$box.find(".sugg-input").val(this.options.placeholder||"");this.$inputWrapper=this.$box.find(".sugg-input-wrapper");this.$suggListWrapper=this.$widget.find(".sugg-list-wrapper");this.$suggList=this.$widget.find(".sugg-list");if(this.options.suggListPosition=="absolute"){this.$suggList.appendTo(document.body);document.body.style.position="relative";this.$suggList.css("position","absolute")}this.$empty=this.$suggList.find(".sugg-empty").html(this.options.emptyText).remove();this.$prompt=this.$suggList.find(".sugg-prompt").html(this.options.prompt||"").remove();this.listItemTemplate=this.options.listItemTemplate||this.$suggList.html();this.$suggList.html("");this.setFlyDirection(this.options.fly);this.$widget.insertBefore(this.$originalInput.hide());this._handleStartValue();if(this.options.minChars==0){this.options.inputSize="";this.$input.width(this.$box.width()-parseFloat(this.$inputWrapper.css("paddingLeft"))-parseFloat(this.$inputWrapper.css("paddingRight"))-parseFloat(this.$inputWrapper.css("marginLeft"))-parseFloat(this.$inputWrapper.css("marginRight"))-parseFloat(this.$inputWrapper.css("borderLeftWidth"))-parseFloat(this.$inputWrapper.css("borderRightWidth"))-parseFloat(this.$input.css("paddingLeft"))-parseFloat(this.$input.css("paddingRight"))-parseFloat(this.$input.css("marginLeft"))-parseFloat(this.$input.css("marginRight"))-parseFloat(this.$input.css("borderLeftWidth"))-parseFloat(this.$input.css("borderRightWidth")))}else{if(this.options.inputSize=="auto"&&this.options.multiselect){this.$input[0].size=this.options.placeholder.length||2}}},_handleStartValue:function(){var g=this.$originalInput.val();if(g){var f=g.replace(/\\,/g,"\u0001,").split(/,/g);this.$originalInput.val("");var h=this;b.each(f,function(){h.add(b.trim(this.replace(/\u0001/g,"")))})}},_setupListeners:function(){this.unfocusTag=b.proxy(this,"unfocusTag");this.removeFocusedTag=b.proxy(this,"removeFocusedTag");this.suggestIfNeeded=b.proxy(this,"suggestIfNeeded");this._closeOnOutsideClick=b.proxy(this,"_closeOnOutsideClick");this.$input.focus(b.proxy(this,"_onInputFocus"));this.$box.delegate(".sugg-remove","click",b.proxy(this,"_onTagRemoveClick"));this.$box.delegate(".sugg-tag","click",b.proxy(this,"_onTagClick"));this.$suggList.mouseover(b.proxy(this,"_onListMouseover"));this.$suggList.click(b.proxy(this,"_onListClick"));this.$box.click(b.proxy(this,"_onBoxClick"));this.$input.keydown(b.proxy(this,"_onKeydown"))},_onInputFocus:function(f){var g=this.$input.val();this.unfocusTag();if(this.options.minChars===0&&this.data.length>0){this.handleSuggestions(this.options.maxSuggestions>0?this.data.slice(0,this.options.maxSuggestions):this.data)}else{if(g===this.options.placeholder){this.$input.val("")}else{if(g===""&!!this.options.prompt){this.showPrompt()}}}},_onTagRemoveClick:function(f){this.unfocusTag();f.preventDefault();f.stopImmediatePropagation();var g=b(f.target).parents(".sugg-tag");this.remove(g)},_onTagClick:function(g){var f=b(g.target);if(!f.hasClass("sugg-tag")){f=f.parents(".sugg-tag")}g.stopImmediatePropagation();this.focusTag(f)},_onListMouseover:function(g){var f=b(g.target);if(f.hasClass("sugg-list")){return}if(!f.hasClass("sugg-item")){f=f.parents(".sugg-item")}if(!f.hasClass("sugg-item")){return}this.deselectAllItems();this.selectItem(f);this.$currentItem=f},_onListClick:function(h){var f=b(h.target);if(f.hasClass("sugg-list")){return}if(!f.hasClass("sugg-item")){f=f.parents(".sugg-item")}if(!f.hasClass("sugg-item")){return}var g=f.data("tag-record");this.add(g[this.options.valueProperty],g[this.options.labelProperty],f);this.closeSuggestBox();if(this.options.multiselect){this.$input.val("");this.focus()}},_onBoxClick:function(f){if(f.target==this.$box[0]){this.unfocusTag();this.focus()}},_onKeydown:function(g){var f=this.publish("BeforeHandleKey",{keydown:g,cancellable:true});if(f.isDefaultPrevented()){return}if(g.which==38){this._key_UP(g)}else{if(g.which==40){this._key_DOWN(g)}else{if(g.which==8){this._key_BACKSPACE(g)}else{if((this.options.addOnTab&&g.which==9)||(this.options.addOnComma&&g.which==188)){this._key_TAB_COMMA(g)}else{if(g.which==27){this._key_ESC(g)}else{if(g.which==13){this._key_ENTER(g)}else{this._key_other(g)}}}}}}if(this.options.inputSize=="auto"){this.$input[0].size=this.$input.val().length+2}this.publish("AfterHandleKey",{keydown:g})},_key_UP:function(f){f.preventDefault();this.unfocusTag();this.moveSelection("up")},_key_DOWN:function(f){f.preventDefault();this.unfocusTag();if(this.isSuggestBoxOpen()){this.moveSelection("down")}},_key_BACKSPACE:function(f){var g;this.$currentItem=null;if(this._isCursorAtStart()){if(this.options.multiselect&&this.tags.length>0){f.preventDefault();g=this.tags[this.tags.length-1].$tag;if(this.$focusedTag&&g&&this.$focusedTag[0]==g[0]){this.remove(g)}else{if(g){this.$focusedTag=g;g.addClass("sugg-focused")}}}this.closeSuggestBox()}else{this._key_other(f)}},_key_TAB_COMMA:function(f){if(f.which==9){if(this.$input.val()==""){return}}f.preventDefault();if(this.$input.val()==""){return}this.$currentItem=null;this.add(this.$input.val());if(this.options.multiselect){this.$input.val("")}this.closeSuggestBox()},_key_ESC:function(f){this.closeSuggestBox()},_key_ENTER:function(g){if(this.$currentItem){var f=this.$currentItem.data("tag-record");this.add(f[this.options.valueProperty],f[this.options.labelProperty],this.$currentItem);if(this.options.multiselect){this.$input.val("")}this.closeSuggestBox();this.$currentItem=null}if(this.options.preventSubmit){g.preventDefault()}},_key_other:function(f){this.abortFetch();clearTimeout(this.timeoutHandle);this.$currentItem=null;this.unfocusTag();this.timeoutHandle=setTimeout(this.suggestIfNeeded,this.options.keyDelay||0)},_beforeFetch:function(g){this._jqXHR=g;var f=this.publish("BeforeFetch",{jqXHR:this._jqXHR,term:this._searchTerm,cancellable:true});if(f.isDefaultPrevented()){this.abortFetch()}},_afterFetch:function(g){var f=this.publish("AfterFetch",{jqXHR:this._jqXHR,records:g,term:this._searchTerm,cancellable:true});this._jqXHR=null;if(f.isDefaultPrevented()){return}this.handleSuggestions(f.records)},_closeOnOutsideClick:function(g){var f=b(g.target);if(f.parents(".sugg-widget")[0]==this.$widget[0]){return}this.closeSuggestBox()},_formatSuggestion:function(g,m){var f,i,h,k,l,j;f=this.publish("BeforeFormat",{record:g,substr:m,html:"",cancellable:true});if(f.isDefaultPrevented()){j=f.html}else{i=this.options;h=g[i.valueProperty];k=i.caseSensitive?f.substr:new RegExp("("+f.substr+")","i");l=i.caseSensitive?f.substr:"$1";j=this.listItemTemplate.replace(/\{record\.(.+?)\}/g,function(o,n){var p=f.record[n];if(typeof p=="string"||!!p){if(n==i.valueProperty&&i.hightlightSubstring){p=p.replace(k,'<strong class="sugg-match">'+l+"</strong>")}return p}return""})}f=this.publish("AfterFormat",{record:f.record,substr:f.substr,html:j});return f.html},save:function(){var g=[],h;b.each(this.tags,function(){g.push(this.value.replace(/,/g,"\\,"))});h=g.join(",");var f=this.publish("BeforeSave",{cancellable:true,newValue:h});if(f.isDefaultPrevented()){return this.$originalInput.val()}this.$originalInput.val(f.newValue);this.publish("AfterSave",{newValue:f.newValue});return f.newValue},_spliceTag:function(g){var f=this.getTagIndex(g);if(f>-1){return this._spliceTagByIdx(f)}return undefined},_spliceTagByIdx:function(f){var g=this.tags[f];g.$hidden.remove();g.$tag.remove();this.tags.splice(f,1);return g},getTagIndex:function(j){var g=-1,h,f;for(h=0,f=this.tags.length;h<f;h++){if(this.tags[h].value==j){g=h;break}}return g},_setupPubsub:function(){this.pubsub=b(this);this.on=b.proxy(this.pubsub,"on");this.off=b.proxy(this.pubsub,"off");this.bind=b.proxy(this.pubsub,"bind");this.once=b.proxy(this.pubsub,"once");this.unbind=b.proxy(this.pubsub,"unbind");this.trigger=b.proxy(this.pubsub,"trigger");this.triggerHandler=b.proxy(this.pubsub,"triggerHandler");for(var f in this.options){if(f.match(/^on[A-Z0-9]/)&&typeof this.options[f]=="function"){this.bind(f.slice(2),this.options[f])}}},_isCursorAtStart:function(){var g=a(this.$input[0]);var f=e(this.$input[0]);return g==0&&f==0}};function a(g){if(g.createTextRange){var f=document.selection.createRange().duplicate();f.moveEnd("character",g.value.length);if(f.text==""){return g.value.length}return g.value.lastIndexOf(f.text)}else{return g.selectionStart}}function e(g){if(g.createTextRange){var f=document.selection.createRange().duplicate();f.moveStart("character",-g.value.length);return f.text.length}else{return g.selectionEnd}}b.Suggester.doSubclass={};b.Suggester.instances=[];b.Suggester.addData=function(f){b.each(b.Suggester.instances,function(){this.addData(f)});return this};b.Suggester.subclass=function(f,g){var h=function(){this.initialize.apply(this,Array.prototype.slice.call(arguments))};h.prototype=new b.Suggester(b.Suggester.doSubclass);h.prototype.callParent=function(i){b.Suggester.prototype[i].apply(this,i,Array.prototype.slice.call(arguments,1))};h.prototype.applyParent=function(j,i){b.Suggester.prototype[j].apply(this,j,i)};b.extend(h.prototype,g||{});c(f,h);return h};function c(f,g){b.fn[f]=function(i){if(typeof i=="string"&&typeof this.data("SuggesterInstance")[i]=="function"){var h=Array.prototype.slice.call(arguments,1);return this.data("SuggesterInstance")[i].apply(this.data("SuggesterInstance"),h)}return this.each(function(){var k=b(this);var j=new g(k,i);k.data("SuggesterInstance",j)})}}c("suggester",b.Suggester)}));
