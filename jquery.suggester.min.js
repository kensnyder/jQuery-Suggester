 /*
 * Suggester: Copyright 2012 Ken Snyder
 * GitHub: https://github.com/kensnyder/jQuery-Suggester
 * MIT Licence: http://www.opensource.org/licenses/mit-license.php
 */
(function(b){"use strict";var c=b(document);b.Suggester=function(){this.initialize.apply(this,Array.prototype.slice.call(arguments))};b.Suggester.defaultOptions={data:false,idProperty:"id",labelProperty:"label",searchProperties:["label"],matchAt:"anywhere",fly:"down",suggListPosition:"relative",dataUrl:false,dataType:"json",preventDuplicates:true,omitAlreadyChosenItems:true,caseSensitive:false,minChars:3,keyDelay:400,submitOnEnter:false,placeholder:"",noSuggestions:"(Type a comma to create a new tag)",prompt:false,maxSuggestions:10,inputPerTag:true,hightlightSubstring:true,template:'<div class="sugg-widget"><ul class="sugg-box"><li class="sugg-box-item sugg-tag"><span class="sugg-label">TAG TEXT GOES HERE</span><span class="sugg-remove" title="Click to remove">&times;</span></li><li class="sugg-box-item sugg-input-wrapper"><input type="text" class="sugg-input" value="" /></li></ul><div class="sugg-list-wrapper"><ul class="sugg-list" style="display:none"><li class="sugg-item {record.cssClass}">{record.label}</li></ul></div></div>',listItemTemplate:null};b.Suggester.prototype={initialize:function(e,d){this.$originalInput=b(e);if(this.$originalInput.data("SuggesterInstance")){return this}b.Suggester.instances.push(this);if(this.$originalInput.length==0){return this}this._processOptions(d);this.data=this.options.data||[];this.tags=[];this.hiddenName=this.$originalInput.attr("name")+"_ids";this.customHiddenName=this.$originalInput.attr("name")+"_custom";this.$focusedTag=false;this.$currentItem=false;this._setupPubsub();this._render();this._setupListeners();this.publish("Initialize");return this},destroy:function(){this.$originalInput.insertBefore(this.$widget).show();this.$widget.empty().remove();var d=this;b.each(b.Suggester.instances,function(e){if(d===this){b.Suggester.instances.splice(e,1);return false}})},addId:function(e){var d=this.findRecordById(e);if(d){return this.addRecord(d)}return undefined},addLabel:function(e){var d=this.findRecordByLabel(e);if(!d){d={_custom:e}}return this.addRecord(d)},addRecord:function(h,k){var m,f,j,g,l,e,d,i;m=this.publish("BeforeAdd",{record:h,item:k,isCustom:!!h._custom});if(m.isDefaultPrevented()){this.save();return undefined}if(m.record._custom){j=m.record._custom;d=this.customHiddenName;g=j}else{f=m.record[this.options.idProperty];j=m.record[this.options.labelProperty];d=this.hiddenName;g=f}if(this.options.preventDuplicates){l=this._findTag(f,j);if(l>-1){this._spliceTagByIdx(l)}}e=b('<input type="hidden" />').attr("name",d+"[]").val(g);if(this.options.inputPerTag){this.$widget.append(e)}i=this.$tagTemplate.clone().data("record",m.record);this.tags.push({record:m.record,$tag:i,$hidden:e});i.find(".sugg-label").html(j);this.$inputWrapper.before(i);this.save();this.publish("AfterAdd",{record:m.record,item:k,tag:i,hidden:e,value:g});return i},moveSelection:function(e){var g=this.$suggList.find(".sugg-item");var f;if(this.$currentItem&&this.$currentItem.length){f=(e=="down"?this.$currentItem.next():this.$currentItem.prev())}else{f=(e=="down"?g.first():g.last())}var d=this.publish("BeforeMove",{direction:e,current:this.$currentItem,next:f,cancellable:true});if(d.isDefaultPrevented()){return this}if(d.current&&d.current.length){this.deselectItem(d.current)}if(d.next&&d.next.length){this.selectItem(d.next)}this.$currentItem=d.next;this.publish("AfterMove",{direction:e,last:d.current,current:this.$currentItem});return this},selectItem:function(d){d.addClass("sugg-selected");return this},deselectItem:function(d){d.removeClass("sugg-selected");return this},deselectAllItems:function(){this.$suggList.find(".sugg-item").removeClass("sugg-selected");this.$currentItem=null;return this},suggest:function(d){this._text=d;if(this.options.dataUrl){this.fetchResults(d)}else{this.handleSuggestions(this.getResults(d))}},addData:function(d){this.data=this.data.concat(d);return this},setData:function(d){this.data=d;return this},getData:function(){return this.data},setFlyDirection:function(d){if(d=="up"){this.$suggListWrapper.insertBefore(this.$box);this.$widget.removeClass("sugg-fly-down").addClass("sugg-fly-up")}else{if(d=="down"){this.$suggListWrapper.insertAfter(this.$box);this.$widget.addClass("sugg-fly-down").removeClass("sugg-fly-up")}}return this},focusTag:function(d){this.unfocusTag();this.$focusedTag=d.addClass("sugg-focused");c.keydown(this.removeFocusedTag).click(this.unfocusTag);return this},unfocusTag:function(){c.unbind("keydown",this.removeFocusedTag).unbind("click",this.unfocusTag);if(this.$focusedTag){this.$focusedTag.removeClass("sugg-focused")}this.$focusedTag=null;return this},removeFocusedTag:function(d){if(d&&d.which&&(d.which==8||d.which==46)){if(this.$focusedTag){this.remove(this.$focusedTag)}d.preventDefault()}this.unfocusTag();return this},remove:function(f){var e,d,i,g,h;if(typeof f.nodeType=="number"&&typeof f.style=="object"){f=b(f)}if(f instanceof b){e=f.data("record")}else{e=f}d=this.publish("BeforeRemove",{tag:f,record:e,cancellable:true});if(d.isDefaultPrevented()){}else{if(!d.record){d.tag.remove()}else{i=d.record[this.options.idProperty];g=d.record._custom||d.record[this.options.labelProperty];h=this._spliceTag(i,g)}}this.publish("AfterRemove",{tag:d.tag,record:d.record,info:h});return this},removeId:function(d){this._spliceTag(d,undefined);return this},removeLabel:function(d){this._spliceTag(undefined,d);return this},findRecordById:function(f){var d,e;e=this.options.idProperty;b.each(this.getData(),function(g,h){if(h[e]==f){d=h;return false}});return d},findRecordByLabel:function(g){var f,h,d;d={};g=""+g;f=false;if(!this.options.caseSensitive){g=g.toLowerCase()}h=this;try{b.each(this.getData(),function(e,j){b.each(h.options.searchProperties,function(){var k=""+(j[this]||"");if(!h.options.caseSensitive){k=k.toLowerCase()}if(k==g){f=j;throw d}})})}catch(i){if(i!==d){throw i}}return f},suggestIfNeeded:function(){var d=this.$input.val();if(d.length>=this.options.minChars){this.suggest(d)}else{if(this.options.prompt){this.showPrompt()}else{this.closeSuggestBox()}}},showPrompt:function(){},fetchResults:function(f){this._searchTerm=f;var e={context:this,url:this.options.dataUrl.replace("%s",f)};if(this.options.dataType=="json"){e.dataType="json"}else{if(this.options.dataType=="jsonp"){e.dataType="jsonp";e.url=e.url.replace("%s","?")}else{throw new Error('jQuery.Suggester#fetchResults: options.dataType must be "json" or "jsonp".')}}var d=this.publish("BeforeAjax",{settings:e,term:f});d.settings.beforeSend=this._beforeFetch;return b.ajax(d.settings).done(this._afterFetch)},abortFetch:function(){if(this._jqXHR){this._jqXHR.abort()}return this},handleSuggestions:function(e){if(!e||e.length==0){this.showEmptyText();return this}var f=this;f.$suggList.empty();b.each(e,function(){var g=b(f._formatSuggestion(this,f._text));g.data("record",this);f.$suggList.append(g)});var d=this.publish("BeforeSuggest",{text:this._text,cancellable:true});if(d.isDefaultPrevented()){return this}this.openSuggestBox();this.publish("AfterSuggest");return this},isSuggestBoxOpen:function(){return this.$suggList.css("display")!="none"},openSuggestBox:function(){var e,g,f,d,j,i,h;if(this.options.suggListPosition=="absolute"){g=b(document.body).offset();j=this.$box.position();if(this.options.fly=="up"){this.$suggList.css("visibility","hidden").show();i=j.top-g.top-this.$box.outerHeight()+this.$box.height()-this.$suggList.outerHeight();this.$suggList.hide().css("visibility","visible")}else{i=j.top-g.top+this.$box.height()}h=j.left-g.left;f=this.$box.outerWidth();this.$suggList.css({top:i+"px",left:h+"px",width:f})}e=this.publish("BeforeOpen",{cancellable:true});if(e.isDefaultPrevented()){return this}this.$suggList.show();this.$widget.addClass("sugg-list-open");c.bind("click",this._closeOnOutsideClick);this.publish("AfterOpen");return this},closeSuggestBox:function(){c.unbind("click",this._closeOnOutsideClick);var d=this.publish("BeforeClose",{cancellable:true});if(!d.isDefaultPrevented()){this.$suggList.hide();this.$widget.removeClass("sugg-list-open")}this.publish("AfterClose");return this},focus:function(){this.$input.triggerHandler("focus");this.$input[0].focus();return this},showEmptyText:function(){if(this.options.emptyText){this.$suggList.html(this.options.emptyTemplate)}this.closeSuggestBox();return this},getResults:function(g){g=""+g;var d=this.publish("BeforeFilter",{text:g});if(!this.options.caseSensitive){d.text=d.text.toLowerCase()}var f=this;var e=[];b.each(this.getData(),function(j,h){if(f.options.omitAlreadyChosenItems&&f._tagExists(h)){return}b.each(f.options.searchProperties,function(){var i=""+(h[this]||"");if(!f.options.caseSensitive){i=i.toLowerCase()}if((f.options.matchAt=="anywhere"&&i.indexOf(d.text)>-1)||(i.indexOf(d.text)==f.options.matchAt)||(f.options.matchAt=="end"&&i.indexOf(d.text)==i.length-d.text-length)){e.push(h);return false}});if(f.options.maxSuggestions>0&&e.length>=f.options.maxSuggestions){return false}});this.publish("AfterFilter",{text:d.text,results:e});return e},publish:function(e,f){var d=b.Event(e);d.target=this;if(f){b.extend(d,f)}this.trigger(d);return d},getInstance:function(){return this},_processOptions:function(d){this.options=b.extend({},b.Suggester.defaultOptions,d);if(this.options.matchAt=="start"||this.options.matchAt=="beginning"){this.options.matchAt=0}},_render:function(){this.$widget=b(this.options.template);this.publish("BeforeRender");this.$box=this.$widget.find(".sugg-box");this.$tagTemplate=this.$box.find(".sugg-tag").remove();this.$input=this.$box.find(".sugg-input").val(this.options.placeholder||"").prop("size",2);this.$inputWrapper=this.$box.find(".sugg-input-wrapper");this.$suggListWrapper=this.$widget.find(".sugg-list-wrapper");this.$suggList=this.$widget.find(".sugg-list");if(this.options.suggListPosition=="absolute"){this.$suggList.appendTo(document.body);document.body.style.position="relative";this.$suggList.css("position","absolute")}this.listItemTemplate=this.options.listItemTemplate||this.$suggList.html();this.$suggList.html("");this.setFlyDirection(this.options.fly);this.$widget.insertBefore(this.$originalInput.hide());this._handleStartValue()},_handleStartValue:function(){var e=this.$originalInput.val();if(e){var d=e.replace(/\\,/g,"\u0001,").split(/,/g);this.$originalInput.val("");var f=this;b.each(d,function(){f.addLabel(b.trim(this.replace(/\u0001/g,"")))})}},_setupListeners:function(){this.unfocusTag=b.proxy(this,"unfocusTag");this.removeFocusedTag=b.proxy(this,"removeFocusedTag");this.suggestIfNeeded=b.proxy(this,"suggestIfNeeded");this._closeOnOutsideClick=b.proxy(this,"_closeOnOutsideClick");this.$input.focus(b.proxy(this,"_onInputFocus"));this.$box.delegate(".sugg-remove","click",b.proxy(this,"_onTagRemoveClick"));this.$box.delegate(".sugg-tag","click",b.proxy(this,"_onTagClick"));this.$suggList.mouseover(b.proxy(this,"_onListMouseover"));this.$suggList.click(b.proxy(this,"_onListClick"));this.$box.click(b.proxy(this,"_onBoxClick"));this.$input.keydown(b.proxy(this,"_onKeydown"))},_onInputFocus:function(d){this.unfocusTag();if(this.$input.val()==this.options.placeholder){this.$input.val("")}},_onTagRemoveClick:function(d){this.unfocusTag();d.preventDefault();d.stopImmediatePropagation();var e=b(d.target).parents(".sugg-tag");this.remove(e)},_onTagClick:function(e){var d=b(e.target);if(!d.hasClass("sugg-tag")){d=d.parents(".sugg-tag")}e.stopImmediatePropagation();this.focusTag(d)},_onListMouseover:function(e){var d=b(e.target);if(d.hasClass("sugg-list")){return}if(!d.hasClass("sugg-item")){d=d.parents(".sugg-item")}if(!d.hasClass("sugg-item")){return}this.deselectAllItems();this.selectItem(d);this.$currentItem=d},_onListClick:function(e){var d=b(e.target);if(d.hasClass("sugg-list")){return}if(!d.hasClass("sugg-item")){d=d.parents(".sugg-item")}if(!d.hasClass("sugg-item")){return}this.addRecord(d.data("record"),d);this.closeSuggestBox();this.$input.val("");this.focus()},_onBoxClick:function(d){if(d.target==this.$box[0]){this.unfocusTag();this.focus()}},_onKeydown:function(e){var d=this.publish("BeforeHandleKey",{event:e,cancellable:true});if(d.isDefaultPrevented()){return}if(e.which==38){this._key_UP(e)}else{if(e.which==40){this._key_DOWN(e)}else{if(e.which==8){this._key_BACKSPACE(e)}else{if(e.which==9||e.which==188){this._key_TAB_COMMA(e)}else{if(e.which==27){this._key_ESC(e)}else{if(e.which==13){this._key_ENTER(e)}else{this._key_other(e)}}}}}}this.$input.prop("size",this.$input.val().length+2);this.publish("AfterHandleKey",{event:e})},_key_UP:function(d){d.preventDefault();this.unfocusTag();this.moveSelection("up")},_key_DOWN:function(d){d.preventDefault();this.unfocusTag();if(this.isSuggestBoxOpen()){this.moveSelection("down")}},_key_BACKSPACE:function(d){var e;this.$currentItem=null;if(a(this.$input[0])==0){d.preventDefault();e=this.tags.length>0?this.tags[this.tags.length-1].$tag:null;if(this.$focusedTag&&e&&this.$focusedTag[0]==e[0]){this.remove(e)}else{if(e){this.$focusedTag=e;e.addClass("sugg-focused")}}this.closeSuggestBox()}else{this._key_other(d)}},_key_TAB_COMMA:function(d){if(d.which==9){if(this.$input.val()==""){return}}d.preventDefault();if(this.$input.val()==""){return}this.$currentItem=null;this.addLabel(this.$input.val());this.$input.val("");this.closeSuggestBox()},_key_ESC:function(d){this.closeSuggestBox()},_key_ENTER:function(d){if(this.$currentItem){this.addRecord(this.$currentItem.data("record"),this.$currentItem);this.$input.val("");this.closeSuggestBox();this.$currentItem=null}else{if(this.options.preventSubmit){d.preventDefault()}}},_key_other:function(d){this.abortFetch();clearTimeout(this.timeoutHandle);this.$currentItem=null;this.unfocusTag();this.timeoutHandle=setTimeout(this.suggestIfNeeded,this.options.keyDelay||0)},_beforeFetch:function(e){this._jqXHR=e;var d=this.publish("BeforeFetch",{jqXHR:this._jqXHR,term:this._searchTerm,cancellable:true});if(d.isDefaultPrevented()){this.abortFetch()}},_afterFetch:function(e){var d=this.publish("AfterFetch",{jqXHR:this._jqXHR,records:e,term:this._searchTerm,cancellable:true});this._jqXHR=null;if(d.isDefaultPrevented()){return}this.handleSuggestions(d.records)},_closeOnOutsideClick:function(d){if(b(d.target).parents(".sugg-list")[0]==this.$suggList[0]){return}this.closeSuggestBox()},_formatSuggestion:function(e,k){var d,g,f,i,j,h;d=this.publish("BeforeFormat",{record:e,substr:k,html:"",cancellable:true});if(d.isDefaultPrevented()){h=d.html}else{g=this.options;f=e[g.labelProperty];i=g.caseSensitive?d.substr:new RegExp("("+d.substr+")","i");j=g.caseSensitive?d.substr:"$1";h=this.listItemTemplate.replace(/\{record\.(.+?)\}/g,function(m,l){var n=d.record[l];if(typeof n=="string"||!!n){if(l==g.labelProperty&&g.hightlightSubstring){n=n.replace(i,'<strong class="sugg-match">'+j+"</strong>")}return n}return""})}d=this.publish("AfterFormat",{record:d.record,substr:d.substr,html:h});return d.html},save:function(){var e=[],f;this.$box.find(".sugg-label").each(function(){e.push(b(this).text().replace(/,/g,"\\,"))});f=e.join(",");var d=this.publish("BeforeSave",{cancellable:true,newValue:f});if(d.isDefaultPrevented()){return this.$originalInput.val()}this.$originalInput.val(d.newValue);this.publish("AfterSave",{newValue:d.newValue});return d.newValue},_spliceTag:function(f,e){var d=this._findTag(f,e);if(d>-1){return this._spliceTagByIdx(d)}return undefined},_spliceTagByIdx:function(d){var e=this.tags[d];e.$hidden.remove();e.$tag.remove();this.tags.splice(d,1);return e},_findTag:function(g,e){var d=-1,f;f=this;b.each(f.tags,function(h,j){if((g&&j.record[f.options.idProperty]==g)||(e&&j.record[f.options.labelProperty]==e)||(e&&j.record._custom==e)){d=h;return false}});return d},_tagExists:function(d){var e=false;b.each(this.tags,function(f){if(this.record==d){e=true;return false}});return e},_setupPubsub:function(){this.pubsub=b(this);this.on=b.proxy(this.pubsub,"on");this.off=b.proxy(this.pubsub,"off");this.bind=b.proxy(this.pubsub,"bind");this.once=b.proxy(this.pubsub,"once");this.unbind=b.proxy(this.pubsub,"unbind");this.trigger=b.proxy(this.pubsub,"trigger");for(var d in this.options){if(d.match(/^on[A-Z0-9]/)&&typeof this.options[d]=="function"){this.bind(d.slice(2),this.options[d])}}}};var a=function(e){if("selectionStart" in e){return e.selectionStart}else{if(document.selection){e.focus();var f=document.selection.createRange();var d=document.selection.createRange().text.length;f.moveStart("character",-e.value.length);return f.text.length-d}else{return e.value.length}}};b.Suggester.instances=[];b.Suggester.addData=function(d){b.each(b.Suggester.instances,function(){this.addData(d)});return this};b.fn.suggester=function(e){if(typeof e=="string"&&typeof b.Suggester.prototype[e]=="function"){var d=Array.prototype.slice.call(arguments,1);return b.Suggester.prototype[e].apply(this.data("SuggesterInstance"),d)}return this.each(function(){var g=b(this);var f=new b.Suggester(g,e);g.data("SuggesterInstance",f)})}})(jQuery);