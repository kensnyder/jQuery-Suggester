 /*
 * Suggester: Copyright 2012 Ken Snyder
 * GitHub: https://github.com/kensnyder/jQuery-Suggester
 * MIT Licence: http://www.opensource.org/licenses/mit-license.php
 */
;(function(b){"use strict";var d=b(document);b.Suggester=function(){if(arguments[0]==b.Suggester.doSubclass){return}this.initialize.apply(this,Array.prototype.slice.call(arguments))};b.Suggester.defaultOptions={data:false,valueProperty:"value",labelProperty:"value",searchProperties:["value"],matchAt:"anywhere",caseSensitive:false,dataUrl:false,dataType:"json",fly:"down",suggListPosition:"relative",multiselect:true,preventDuplicates:true,omitAlreadyChosenItems:true,minChars:3,keyDelay:400,addOnComma:true,addOnTab:true,submitOnEnter:false,inputSize:"auto",placeholder:"",emptyText:"(Type a comma to create a new item)",prompt:false,maxSuggestions:10,addHiddenInputs:true,hightlightSubstring:true,template:'<div class="sugg-widget"><ul class="sugg-box"><li class="sugg-box-item sugg-tag"><span class="sugg-label">TAG TEXT GOES HERE</span><span class="sugg-remove" title="Click to remove">&times;</span></li><li class="sugg-box-item sugg-input-wrapper"><input type="text" class="sugg-input" value="" /></li></ul><div class="sugg-list-wrapper"><ul class="sugg-list" style="display:none"><li class="sugg-item {record.cssClass}">{record.value}</li><li class="sugg-empty"></li><li class="sugg-prompt"></li></ul></div></div>',listItemTemplate:null};b.Suggester.prototype={initialize:function(f,e){this.$originalInput=b(f);if(this.$originalInput.data("SuggesterInstance")){return this}b.Suggester.instances.push(this);if(this.$originalInput.length==0){return this}this._processOptions(e);this.setData(this.options.data||[]);this.tags=[];this.hiddenName=this.$originalInput.attr("name")+"_tags[]";this.$focusedTag=false;this.$currentItem=false;this._setupPubsub();this._render();this._setupListeners();this.publish("Initialize");return this},destroy:function(){this.$originalInput.insertBefore(this.$widget).show();this.$widget.empty().remove();var e=this;b.each(b.Suggester.instances,function(f){if(e===this){b.Suggester.instances.splice(f,1);return false}});return this.$originalInput},add:function(j,i,h){var f,e,k,g;if(typeof i!="string"){i=j}f=this.publish("BeforeAdd",{value:j,label:i,item:h,record:h?h.data("tag-record"):undefined});if(f.isDefaultPrevented()){this.save();return undefined}if(this.options.preventDuplicates){e=this.getTagIndex(j);if(e>-1){this._spliceTagByIdx(e)}}if(this.options.addHiddenInputs){k=b('<input type="hidden" />').attr("name",this.hiddenName).val(j);this.$widget.append(k)}g=this.$tagTemplate.clone().data("tag-value",f.value).data("tag-label",f.label);this.tags.push({$tag:g,$hidden:k,value:f.value,label:f.label});if(this.options.multiselect){g.find(".sugg-label").html(f.label);this.$inputWrapper.before(g)}else{this.$input.val(f.value)}this.save();this.publish("AfterAdd",{item:h,tag:g,hidden:k,value:f.value,label:f.label});return g},moveSelection:function(f){var h=this.$suggList.find(".sugg-item");var g;if(this.$currentItem&&this.$currentItem.length){g=(f=="down"?this.$currentItem.next():this.$currentItem.prev())}else{g=(f=="down"?h.first():h.last())}var e=this.publish("BeforeMove",{direction:f,current:this.$currentItem,next:g,cancellable:true});if(e.isDefaultPrevented()){return this}if(e.current&&e.current.length){this.deselectItem(e.current)}if(e.next&&e.next.length){this.selectItem(e.next)}this.$currentItem=e.next;this.publish("AfterMove",{direction:f,last:e.current,current:this.$currentItem});return this},selectItem:function(e){e.addClass("sugg-selected");return this},deselectItem:function(e){e.removeClass("sugg-selected");return this},deselectAllItems:function(){this.$suggList.find(".sugg-item").removeClass("sugg-selected");this.$currentItem=null;return this},suggest:function(e){this._text=e;if(this.options.dataUrl){this.fetchResults(e)}else{this.handleSuggestions(this.getResults(e))}},addData:function(h){var g,e,f;if(h.length>0&&typeof h[0]!="object"){for(g=0,e=h.length;g<e;g++){f={};f[this.options.valueProperty]=""+h[g];this.data.push(f)}}else{this.data=this.data.concat(h)}return this},setData:function(e){this.data=[];this.addData(e);return this},getData:function(){return this.data},setFlyDirection:function(e){if(e=="up"){this.$suggListWrapper.insertBefore(this.$box);this.$widget.removeClass("sugg-fly-down").addClass("sugg-fly-up")}else{if(e=="down"){this.$suggListWrapper.insertAfter(this.$box);this.$widget.addClass("sugg-fly-down").removeClass("sugg-fly-up")}}return this},focusTag:function(e){this.unfocusTag();this.$focusedTag=e.addClass("sugg-focused");d.keydown(this.removeFocusedTag).click(this.unfocusTag);return this},unfocusTag:function(){d.unbind("keydown",this.removeFocusedTag).unbind("click",this.unfocusTag);if(this.$focusedTag){this.$focusedTag.removeClass("sugg-focused")}this.$focusedTag=null;return this},removeFocusedTag:function(e){if(e&&e.which&&(e.which==8||e.which==46)){if(this.$focusedTag){this.remove(this.$focusedTag)}e.preventDefault()}this.unfocusTag();return this},remove:function(f){var e,g,h;if(typeof f.nodeType=="number"&&typeof f.style=="object"){f=b(f)}if(f instanceof b){g=f.data("tag-value")}else{g=f;f=false;b.each(this.tags,function(){if(g==this.value){f=this.$tag;return false}})}e=this.publish("BeforeRemove",{tag:f,value:g,cancellable:true});if(e.isDefaultPrevented()){return this}h=this._spliceTag(e.value);this.publish("AfterRemove",{tag:e.tag,value:g,removed:h});return this},findRecord:function(j){var g,h,f;f={};g=false;if(!this.options.caseSensitive){j=j.toLowerCase()}h=this;try{b.each(this.getData(),function(e,k){b.each(h.options.searchProperties,function(){var l=""+(k[this]||"");if(!h.options.caseSensitive){l=l.toLowerCase()}if(l==j){g=k;throw f}})})}catch(i){if(i!==f){throw i}}return g},suggestIfNeeded:function(){var e=this.$input.val();if(e.length>=this.options.minChars){this.suggest(e)}else{if(this.options.prompt){this.showPrompt()}else{this.closeSuggestBox()}}return this},showPrompt:function(){if(!this.$prompt){return this}this.$suggList.html("").append(this.$prompt);this.openSuggestBox();this.$widget.addClass("sugg-prompt-shown");return this},showEmptyText:function(){if(!this.$empty){return this}this.$suggList.html("").append(this.$empty);this.openSuggestBox();this.$widget.addClass("sugg-empty-shown");return this},fetchResults:function(g){this._searchTerm=g;var f={context:this,url:this.options.dataUrl.replace("%s",g)};if(this.options.dataType.toLowerCase()=="json"){f.dataType="json"}else{if(this.options.dataType.toLowerCase()=="jsonp"){f.dataType="jsonp";f.url=f.url.replace("%s","?")}else{throw new Error('jQuery.Suggester#fetchResults: options.dataType must be "json" or "jsonp".')}}var e=this.publish("BeforeAjax",{settings:f,term:g});e.settings.beforeSend=this._beforeFetch;return b.ajax(e.settings).done(this._afterFetch)},abortFetch:function(){if(this._jqXHR){this._jqXHR.abort()}return this},handleSuggestions:function(f){if(!f||f.length==0){this.showEmptyText();return this}var g=this;g.$suggList.empty();b.each(f,function(){var h=b(g._formatSuggestion(this,g._text));h.data("tag-record",this);g.$suggList.append(h)});var e=this.publish("BeforeSuggest",{text:this._text,cancellable:true});if(e.isDefaultPrevented()){return this}this.openSuggestBox();this.publish("AfterSuggest");return this},isSuggestBoxOpen:function(){return this.$suggList.css("display")!="none"},openSuggestBox:function(){var f,i,h,e,l,k,j,g=this;if(this.options.suggListPosition=="absolute"){i=b(document.body).offset();l=this.$box.position();if(this.options.fly=="up"){this.$suggList.css("visibility","hidden").show();k=l.top-i.top-this.$box.outerHeight()+this.$box.height()-this.$suggList.outerHeight();this.$suggList.hide().css("visibility","visible")}else{k=l.top-i.top+this.$box.height()}j=l.left-i.left;h=this.$box.outerWidth();this.$suggList.css({top:k+"px",left:j+"px",width:h})}f=this.publish("BeforeOpen",{cancellable:true});if(f.isDefaultPrevented()){return this}this.$widget.addClass("sugg-list-open").removeClass("sugg-prompt-shown").removeClass("sugg-empty-shown");setTimeout(function(){d.bind("click",g._closeOnOutsideClick)},0);this.$suggList.show();this.publish("AfterOpen");return this},closeSuggestBox:function(){d.unbind("click",this._closeOnOutsideClick);var e=this.publish("BeforeClose",{cancellable:true});if(!e.isDefaultPrevented()){this.$suggList.hide();this.$widget.removeClass("sugg-list-open")}this.publish("AfterClose");return this},focus:function(){this.$input[0].focus();return this},getResults:function(h){h=""+h;var e=this.publish("BeforeFilter",{text:h});if(!this.options.caseSensitive){e.text=e.text.toLowerCase()}var g=this;var f=[];b.each(this.getData(),function(k,j){if(g.options.omitAlreadyChosenItems&&g.getTagIndex(j[g.options.valueProperty])>-1){return}b.each(g.options.searchProperties,function(){var i=""+(j[this]||"");if(!g.options.caseSensitive){i=i.toLowerCase()}if((g.options.matchAt=="anywhere"&&i.indexOf(e.text)>-1)||(i.indexOf(e.text)==g.options.matchAt)||(g.options.matchAt=="end"&&i.indexOf(e.text)==i.length-e.text-length)){f.push(j);return false}});if(g.options.maxSuggestions>0&&f.length>=g.options.maxSuggestions){return false}});this.publish("AfterFilter",{text:e.text,results:f});return f},publish:function(f,g){var e=b.Event(f);e.target=this;if(g){b.extend(e,g)}this.trigger(e);return e},getInstance:function(){return this},_processOptions:function(e){this.options=b.extend({},b.Suggester.defaultOptions,e);if(this.options.matchAt=="start"||this.options.matchAt=="beginning"){this.options.matchAt=0}},_render:function(){this.$widget=b(this.options.template);this.publish("BeforeRender");this.$box=this.$widget.find(".sugg-box");this.$tagTemplate=this.$box.find(".sugg-tag").remove();this.$input=this.$box.find(".sugg-input").val(this.options.placeholder||"");this.$inputWrapper=this.$box.find(".sugg-input-wrapper");this.$suggListWrapper=this.$widget.find(".sugg-list-wrapper");this.$suggList=this.$widget.find(".sugg-list");if(this.options.suggListPosition=="absolute"){this.$suggList.appendTo(document.body);document.body.style.position="relative";this.$suggList.css("position","absolute")}this.$empty=this.$suggList.find(".sugg-empty").html(this.options.emptyText).remove();this.$prompt=this.$suggList.find(".sugg-prompt").html(this.options.prompt||"").remove();this.listItemTemplate=this.options.listItemTemplate||this.$suggList.html();this.$suggList.html("");this.setFlyDirection(this.options.fly);this.$widget.insertBefore(this.$originalInput.hide());this._handleStartValue();if(this.options.minChars==0){this.options.inputSize="";this.$input.width(this.$box.width()-parseFloat(this.$inputWrapper.css("paddingLeft"))-parseFloat(this.$inputWrapper.css("paddingRight"))-parseFloat(this.$inputWrapper.css("marginLeft"))-parseFloat(this.$inputWrapper.css("marginRight"))-parseFloat(this.$inputWrapper.css("borderLeftWidth"))-parseFloat(this.$inputWrapper.css("borderRightWidth"))-parseFloat(this.$input.css("paddingLeft"))-parseFloat(this.$input.css("paddingRight"))-parseFloat(this.$input.css("marginLeft"))-parseFloat(this.$input.css("marginRight"))-parseFloat(this.$input.css("borderLeftWidth"))-parseFloat(this.$input.css("borderRightWidth")))}else{this.$input[0].size=this.options.inputSize=="auto"?(this.options.placeholder.length||2):this.options.inputSize}},_handleStartValue:function(){var f=this.$originalInput.val();if(f){var e=f.replace(/\\,/g,"\u0001,").split(/,/g);this.$originalInput.val("");var g=this;b.each(e,function(){g.add(b.trim(this.replace(/\u0001/g,"")))})}},_setupListeners:function(){this.unfocusTag=b.proxy(this,"unfocusTag");this.removeFocusedTag=b.proxy(this,"removeFocusedTag");this.suggestIfNeeded=b.proxy(this,"suggestIfNeeded");this._closeOnOutsideClick=b.proxy(this,"_closeOnOutsideClick");this.$input.focus(b.proxy(this,"_onInputFocus"));this.$box.delegate(".sugg-remove","click",b.proxy(this,"_onTagRemoveClick"));this.$box.delegate(".sugg-tag","click",b.proxy(this,"_onTagClick"));this.$suggList.mouseover(b.proxy(this,"_onListMouseover"));this.$suggList.click(b.proxy(this,"_onListClick"));this.$box.click(b.proxy(this,"_onBoxClick"));this.$input.keydown(b.proxy(this,"_onKeydown"))},_onInputFocus:function(e){var f=this.$input.val();this.unfocusTag();if(this.options.minChars===0&&this.data.length>0){this.handleSuggestions(this.options.maxSuggestions>0?this.data.slice(0,this.options.maxSuggestions):this.data)}else{if(f===this.options.placeholder){this.$input.val("")}else{if(f===""&!!this.options.prompt){this.showPrompt()}}}},_onTagRemoveClick:function(e){this.unfocusTag();e.preventDefault();e.stopImmediatePropagation();var f=b(e.target).parents(".sugg-tag");this.remove(f)},_onTagClick:function(f){var e=b(f.target);if(!e.hasClass("sugg-tag")){e=e.parents(".sugg-tag")}f.stopImmediatePropagation();this.focusTag(e)},_onListMouseover:function(f){var e=b(f.target);if(e.hasClass("sugg-list")){return}if(!e.hasClass("sugg-item")){e=e.parents(".sugg-item")}if(!e.hasClass("sugg-item")){return}this.deselectAllItems();this.selectItem(e);this.$currentItem=e},_onListClick:function(g){var e=b(g.target);if(e.hasClass("sugg-list")){return}if(!e.hasClass("sugg-item")){e=e.parents(".sugg-item")}if(!e.hasClass("sugg-item")){return}var f=e.data("tag-record");this.add(f[this.options.valueProperty],f[this.options.labelProperty],e);this.closeSuggestBox();if(this.options.multiselect){this.$input.val("");this.focus()}},_onBoxClick:function(e){if(e.target==this.$box[0]){this.unfocusTag();this.focus()}},_onKeydown:function(f){var e=this.publish("BeforeHandleKey",{keydown:f,cancellable:true});if(e.isDefaultPrevented()){return}if(f.which==38){this._key_UP(f)}else{if(f.which==40){this._key_DOWN(f)}else{if(f.which==8){this._key_BACKSPACE(f)}else{if((this.options.addOnTab&&f.which==9)||(this.options.addOnComma&&f.which==188)){this._key_TAB_COMMA(f)}else{if(f.which==27){this._key_ESC(f)}else{if(f.which==13){this._key_ENTER(f)}else{this._key_other(f)}}}}}}if(this.options.inputSize=="auto"){this.$input[0].size=this.$input.val().length+2}this.publish("AfterHandleKey",{keydown:f})},_key_UP:function(e){e.preventDefault();this.unfocusTag();this.moveSelection("up")},_key_DOWN:function(e){e.preventDefault();this.unfocusTag();if(this.isSuggestBoxOpen()){this.moveSelection("down")}},_key_BACKSPACE:function(e){var f;this.$currentItem=null;if(a(this.$input[0])==0){e.preventDefault();f=this.tags.length>0?this.tags[this.tags.length-1].$tag:null;if(this.$focusedTag&&f&&this.$focusedTag[0]==f[0]){this.remove(f)}else{if(f){this.$focusedTag=f;f.addClass("sugg-focused")}}this.closeSuggestBox()}else{this._key_other(e)}},_key_TAB_COMMA:function(e){if(e.which==9){if(this.$input.val()==""){return}}e.preventDefault();if(this.$input.val()==""){return}this.$currentItem=null;this.add(this.$input.val());if(this.options.multiselect){this.$input.val("")}this.closeSuggestBox()},_key_ESC:function(e){this.closeSuggestBox()},_key_ENTER:function(f){if(this.$currentItem){var e=this.$currentItem.data("tag-record");this.add(e[this.options.valueProperty],e[this.options.labelProperty],this.$currentItem);if(this.options.multiselect){this.$input.val("")}this.closeSuggestBox();this.$currentItem=null}else{if(this.options.preventSubmit){f.preventDefault()}}},_key_other:function(e){this.abortFetch();clearTimeout(this.timeoutHandle);this.$currentItem=null;this.unfocusTag();this.timeoutHandle=setTimeout(this.suggestIfNeeded,this.options.keyDelay||0)},_beforeFetch:function(f){this._jqXHR=f;var e=this.publish("BeforeFetch",{jqXHR:this._jqXHR,term:this._searchTerm,cancellable:true});if(e.isDefaultPrevented()){this.abortFetch()}},_afterFetch:function(f){var e=this.publish("AfterFetch",{jqXHR:this._jqXHR,records:f,term:this._searchTerm,cancellable:true});this._jqXHR=null;if(e.isDefaultPrevented()){return}this.handleSuggestions(e.records)},_closeOnOutsideClick:function(f){var e=b(f.target);if(e.parents(".sugg-widget")[0]==this.$widget[0]){return}this.closeSuggestBox()},_formatSuggestion:function(f,l){var e,h,g,j,k,i;e=this.publish("BeforeFormat",{record:f,substr:l,html:"",cancellable:true});if(e.isDefaultPrevented()){i=e.html}else{h=this.options;g=f[h.valueProperty];j=h.caseSensitive?e.substr:new RegExp("("+e.substr+")","i");k=h.caseSensitive?e.substr:"$1";i=this.listItemTemplate.replace(/\{record\.(.+?)\}/g,function(n,m){var o=e.record[m];if(typeof o=="string"||!!o){if(m==h.valueProperty&&h.hightlightSubstring){o=o.replace(j,'<strong class="sugg-match">'+k+"</strong>")}return o}return""})}e=this.publish("AfterFormat",{record:e.record,substr:e.substr,html:i});return e.html},save:function(){var f=[],g;b.each(this.tags,function(){f.push(this.value.replace(/,/g,"\\,"))});g=f.join(",");var e=this.publish("BeforeSave",{cancellable:true,newValue:g});if(e.isDefaultPrevented()){return this.$originalInput.val()}this.$originalInput.val(e.newValue);this.publish("AfterSave",{newValue:e.newValue});return e.newValue},_spliceTag:function(f){var e=this.getTagIndex(f);if(e>-1){return this._spliceTagByIdx(e)}return undefined},_spliceTagByIdx:function(e){var f=this.tags[e];f.$hidden.remove();f.$tag.remove();this.tags.splice(e,1);return f},getTagIndex:function(h){var f=-1,g,e;for(g=0,e=this.tags.length;g<e;g++){if(this.tags[g].value==h){f=g;break}}return f},_setupPubsub:function(){this.pubsub=b(this);this.on=b.proxy(this.pubsub,"on");this.off=b.proxy(this.pubsub,"off");this.bind=b.proxy(this.pubsub,"bind");this.once=b.proxy(this.pubsub,"once");this.unbind=b.proxy(this.pubsub,"unbind");this.trigger=b.proxy(this.pubsub,"trigger");this.triggerHandler=b.proxy(this.pubsub,"triggerHandler");for(var e in this.options){if(e.match(/^on[A-Z0-9]/)&&typeof this.options[e]=="function"){this.bind(e.slice(2),this.options[e])}}}};var a=function(f){if("selectionStart" in f){return f.selectionStart}else{if(document.selection){f.focus();var g=document.selection.createRange();var e=document.selection.createRange().text.length;g.moveStart("character",-f.value.length);return g.text.length-e}else{return f.value.length}}};b.Suggester.doSubclass={};b.Suggester.instances=[];b.Suggester.addData=function(e){b.each(b.Suggester.instances,function(){this.addData(e)});return this};b.Suggester.subclass=function(e,f){var g=function(){this.initialize.apply(this,Array.prototype.slice.call(arguments))};g.prototype=new b.Suggester(b.Suggester.doSubclass);g.prototype.callParent=function(h){b.Suggester.prototype[h].apply(this,h,Array.prototype.slice.call(arguments,1))};g.prototype.applyParent=function(i,h){b.Suggester.prototype[i].apply(this,i,h)};b.extend(g.prototype,f||{});c(e,g);return g};function c(e,f){b.fn[e]=function(h){if(typeof h=="string"&&typeof this.data("SuggesterInstance")[h]=="function"){var g=Array.prototype.slice.call(arguments,1);return this.data("SuggesterInstance")[h].apply(this.data("SuggesterInstance"),g)}return this.each(function(){var j=b(this);var i=new f(j,h);j.data("SuggesterInstance",i)})}}c("suggester",b.Suggester)})(jQuery);