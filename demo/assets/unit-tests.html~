<!doctype html>
<html>
<head>
	<meta charset="utf-8" />
	<title>jquery.suggester.js Unit Tests</title>
	<script src="http://code.jquery.com/jquery-1.8.0.min.js"></script>
	<script src="http://code.jquery.com/qunit/qunit-1.10.0.js"></script>
	<script src="./jquery.suggester.js"></script>
	<link rel="stylesheet" href="http://code.jquery.com/qunit/qunit-1.10.0.css" />
</head>
<body>
<div id="qunit"></div>
<script>
function sendKeys(sugg, arr) {
	jQuery.each(arr, function() {
		sendKey(sugg, this);
	});
}
function sendKey(sugg, str) {
	var special = {
		UP: 39,
		DOWN: 40,
		BACKSPACE: 8,
		DELETE: 46,
		TAB: 9,
		',': 188,
		ENTER: 13
	};
	(sugg.$input || $(document)).trigger({
		type: 'keydown', 
		which: special[str] || str.charCodeAt(0)
	});
	if (!special[str]) {		
		sugg.$input[0].value += str;
	}
}
(function($) { "use strict";
	// reused vars
	var $form, $input;
	// sample data
	var data = [
		{id: 1, label: "Sun"},	
		{id: 2, label: "Mercury"},
		{id: 3, label: "Venus"},
		{id: 4, label: "Earth"},
		{id: 5, label: "Mars"},
		{id: 6, label: "Asteroid Belt"},
		{id: 7, label: "Jupiter"},
		{id: 8, label: "Saturn"},
		{id: 9, label: "Uranus"},
		{id:10, label: "Neptune"},
		{id:11, label: "Pluto"},
		{id:12, label: "Eres"}
	];
	var fixtures = {
		// setup a test form
		setup: function() {
			$('<form class="sugg"><input type="text" name="suggesstable" value="" /></form>').appendTo(document.body);
			$form = $('.sugg');
			$input = $('.sugg input');
		},
		// teardown the form
		teardown: function() {
			$form.remove();
			$('.sugg-list').remove();
		}
	};
	module('Adding Tags', fixtures);
	test("Original element is not visible", function() {
		$input.suggester();
		strictEqual($input.is(':visible'), false);
	});
	test("Form has new text input", function() {
		$input.suggester();
		strictEqual($form.find('input[type=text]:visible').length, 1);
	});
	test("add() an arbitrary item", function() {
		$input.suggester();
		$input.suggester('add', 100, 'Custom');
		strictEqual($form.find('input[type=hidden]').val(), '100');
		strictEqual($form.find('.sugg-label').html(), 'Custom');
	});	
	test("addId()", function() {
		$input.suggester({data:data});
		var $tag = $input.suggester('addId', 1);
		strictEqual($tag.attr('data-id'), '1');
		strictEqual($tag.attr('data-label'), 'Sun');
		strictEqual($form.find('input[type=hidden]').val(), '1');
		strictEqual($form.find('.sugg-label').html(), 'Sun');
	});
	test("addTag()", function() {
		$input.suggester({data:data});
		var $tag = $input.suggester('addTag', 'Pluto');
		strictEqual($tag.attr('data-id'), '11');
		strictEqual($tag.attr('data-label'), 'Pluto');
		strictEqual($form.find('input[type=hidden]').val(), '11');
		strictEqual($form.find('.sugg-label').html(), 'Pluto');
	});	
	test("Add by typing", function() {
		var sugg = $input.suggester({data:data}).suggester('getInstance');
		sugg.$input.val('Mars');
		sendKey(sugg, ',');
		strictEqual($form.find('input[type=hidden]').val(), '5');
		strictEqual($form.find('.sugg-label').html(), 'Mars');	
		strictEqual(sugg.$input.val(), '');	
	});
	test("Add by typing custom", function() {
		var sugg = $input.suggester({data:data}).suggester('getInstance');
		sugg.$input.val('Custom');
		sendKey(sugg, ',');
		strictEqual($form.find('input[type=hidden]').val(), 'Custom');
		strictEqual($form.find('.sugg-label').html(), 'Custom');		
		strictEqual(sugg.$input.val(), '');	
	});
	test("addId() then removeId()", function() {
		$input.suggester({data:data});
		var $tag = $input.suggester('addId', 1);
		strictEqual($tag.attr('data-id'), '1');
		strictEqual($tag.attr('data-label'), 'Sun');
		strictEqual($form.find('input[type=hidden]').val(), '1');
		strictEqual($form.find('.sugg-label').html(), 'Sun');
		$input.suggester('removeId', 1);
		strictEqual($form.find('input[type=hidden]').length, 0);
		strictEqual($form.find('.sugg-label').length, 0);
	});	
	test("addId() then remove by delete key", function() {
		var sugg = $input.suggester({data:data}).suggester('getInstance');
		var $tag = sugg.addId(1);
		sendKeys(sugg, ['BACKSPACE']);
		strictEqual($tag.hasClass('sugg-selected'), true);
		sendKeys(sugg, ['BACKSPACE']);
		strictEqual($form.find('input[type=hidden]').length, 0);
		strictEqual($form.find('.sugg-label').length, 0);
	});
	test("addId() then click to select", function() {
		var sugg = $input.suggester({data:data}).suggester('getInstance');
		var $tag = sugg.addId(1);
		$tag.trigger({type: 'click'});
		//sugg.$box.trigger({type: 'click', target:$tag[0]});
		strictEqual($tag.hasClass('sugg-selected'), true);
	});	
	test("addId() then remove by clicking `X`", function() {
		var sugg = $input.suggester({data:data}).suggester('getInstance');
		var $tag = sugg.addId(2);
		$tag.find('.sugg-remove').trigger({type: 'click'});
		strictEqual($form.find('input[type=hidden]').length, 0);
		strictEqual($form.find('.sugg-label').length, 0);
	});
	test("addId() then click to select, then delete key", function() {
		var sugg = $input.suggester({data:data}).suggester('getInstance');
		var $tag = sugg.addId(3);
		// Suggester uses delegation so we have to fake the click on sugg.$box
		sugg.$box.trigger({type: 'click', target:$tag[0]});
		sendKey(document, 'DELETE');
		strictEqual($form.find('input[type=hidden]').length, 0);
		strictEqual($form.find('.sugg-label').length, 0);		
	});	
		
	module('Suggestions', fixtures);
	asyncTest("Too short for suggestion", function() {
		expect(1);
		var sugg = $input.suggester({data:data,minChars:3,keyDelay:0}).suggester('getInstance');
		sendKeys(sugg, ['J','u']);
		setTimeout(function() {
			strictEqual($form.find('.sugg-item').length, 0);
			start();
		}, 1);
	});		
	asyncTest("2 letters", function() {
		expect(3);
		var sugg = $input.suggester({data:data,minChars:1,keyDelay:0}).suggester('getInstance');
		sendKeys(sugg, ['O']);
		setTimeout(function() {
			strictEqual($('.sugg-item').length, 2);
			strictEqual($('.sugg-item').eq(0).text(), 'Asteroid Belt');
			strictEqual($('.sugg-item').eq(1).text(), 'Pluto');		
			start();
		}, 1);
	});	
	
}(jQuery, QUnit));
</script>
</body>
</html>
