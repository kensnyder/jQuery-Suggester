/*! Suggester - A Better Autocomplete Widget - v1.3.0 - Jul 2013
* https://github.com/kensnyder/jQuery-Suggester
* Copyright (c) 2013 Ken Snyder; Licensed MIT */
(function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t(jQuery)})(function(t){"use strict";function e(e){var s=document.createElement(e);return t(s)}function s(t){if(t.createTextRange){var e=document.selection.createRange().duplicate();return e.moveEnd("character",t.value.length),""===e.text?t.value.length:t.value.lastIndexOf(e.text)}return t.selectionStart}function i(t){if(t.createTextRange){var e=document.selection.createRange().duplicate();return e.moveStart("character",-t.value.length),e.text.length}return t.selectionEnd}function n(e,s){t.fn[e]=function(e){var i=this.data("SuggesterInstance");if("string"==typeof e&&i instanceof t.Suggester&&"function"==typeof i[e]){var n=Array.prototype.slice.call(arguments,1);return i[e].apply(i,n)}return i?this:this.each(function(){var i=t(this),n=new s(i,e);i.data("SuggesterInstance",n)})}}t.fn.suggSetValue=function(t){return this.length>0&&(this[0].value=t),this},t.fn.suggGetValue=function(){return 0===this.length?void 0:this[0].value},t.fn.suggAppend=function(t){return this.length>0&&t.length>0&&this[0].appendChild(t[0]),this},t.fn.suggInsertAfter=function(t){return this.length>0&&t.length>0&&(this[0].nextSibling?t[0].parentNode.insertBefore(t[0],this[0].nextSibling):t[0].parentNode.appendChild(this[0])),this},t.fn.suggInsertBefore=function(t){return this.length>0&&t.length>0&&t[0].parentNode.insertBefore(this[0],t[0]),this},t.fn.suggSetAttr=function(t,e){return this.length>0&&this[0].setAttribute(t,e),this};var o,r=t(document);t.Suggester=function(){arguments[0]!==t.Suggester.doSubclass&&this.initialize.apply(this,Array.prototype.slice.call(arguments))},t.Suggester.defaultOptions={data:!1,valueProperty:"value",labelProperty:"value",searchProperties:["value"],matchAt:"anywhere",caseSensitive:!1,dataUrl:!1,dataType:"json",fly:"down",suggListPosition:"relative",multiselect:!0,preventDuplicates:!0,omitAlreadyChosenItems:!0,minChars:3,keyDelay:400,addOnComma:!0,addOnTab:!0,addOnSemicolon:!1,addOnSubmit:!0,addOnBlur:!1,submitOnEnter:!1,inputSize:"auto",placeholder:"",emptyText:"(Type a comma to create a new item)",prompt:!1,maxSuggestions:10,saveToInput:!0,addHiddenInputs:!0,hiddenName:null,hightlightSubstring:!0,template:'<div class="sugg-widget"><ul class="sugg-box"><li class="sugg-box-item sugg-tag"><span class="sugg-label">TAG TEXT GOES HERE</span><span class="sugg-remove" title="Click to remove">&times;</span></li><li class="sugg-box-item sugg-input-wrapper"><input type="text" class="sugg-input" value="" autocomplete="off" /></li></ul><div class="sugg-list-wrapper"><ul class="sugg-list" style="display:none"><li class="sugg-item {record.cssClass}">{record.value}</li><li class="sugg-empty"></li><li class="sugg-prompt"></li></ul></div></div>',listItemTemplate:null,theme:"coolblue"},t.Suggester.prototype={initialize:function(e,s){return this.$originalInput=t(e),this.$form=t(this.$originalInput.prop("form")),this.$originalInput.data("SuggesterInstance")?this:(t.Suggester.instances.push(this),0===this.$originalInput.length?this:(this._processOptions(s),this.setData(this.options.data||[]),this.tags=[],this.hiddenName=this.options.hiddenName||this.$originalInput.suggSetAttr("name")+"_tags[]",this.$focusedTag=!1,this.$currentItem=!1,this._setupPubsub(),this._render(),this._setupListeners(),this.publish("Initialize"),this))},destroy:function(e){e=e||{},this.$originalInput.suggInsertBefore(this.$widget).show(),this.$originalInput.removeData("SuggesterInstance"),e.keepHiddenInputs&&this.$widget.find("input[type=hidden]").suggInsertBefore(this.$widget),this.tags=[],this.data=[],this.$widget.empty().remove();for(var s=this,i=0,n=t.Suggester.instances.length;n>i;i++)if(s===t.Suggester.instances[i])return t.Suggester.instances.splice(i,1),!1;return this.$originalInput},add:function(t,e,s){var i,n,o,r=null===t||void 0===t||t===!1,u=null===e||void 0===e||e===!1;if(1==arguments.length?o=this.searchData(t,this.options.valueProperty===this.options.labelProperty?[this.options.valueProperty]:[this.options.valueProperty,this.options.labelProperty]):2!=arguments.length||r||u?2==arguments.length&&r&&!u?o=this.searchData(e,[this.options.labelProperty]):2==arguments.length&&!r&&u?o=this.searchData(t,[this.options.valueProperty]):s&&(o=s.data("tag-record")):(o=this.searchData(t,[this.options.valueProperty]),o&&o[this.options.labelProperty]==e||(o=void 0)),o&&(t=o[this.options.valueProperty],e=o[this.options.labelProperty]),"string"!=typeof e&&"number"!=typeof e&&(e=t),"string"!=typeof t&&"number"!=typeof t&&(t=e),i=this.publish("BeforeAdd",{value:t,label:e,item:s,record:o}),i.isDefaultPrevented())return void 0;this.options.preventDuplicates&&(n=this.getTagIndex(t),n>-1&&this._spliceTagByIdx(n));var a=this.pushTag(i.value,i.label);return this.options.saveToInput&&this.save(),this.hidePlaceholder(),this.publish("AfterAdd",{item:i.item,tag:a.getElement(),hidden:a.getHidden(),value:i.value,label:i.label,record:i.record}),this.publish("Change"),a.getElement()},pushTag:function(s,i){var n,o,r;return this.options.addHiddenInputs&&(n=e("input").suggSetAttr("type","hidden").suggSetAttr("name",this.hiddenName).suggSetValue(s),this.$widget.suggAppend(n)),o=this.$tagTemplate.clone().data("tag-value",s).data("tag-label",i),r=new t.Suggester.Tag({suggester:this,index:this.tags.length,$tag:o,$hidden:n,value:s,label:i}),this.tags.push(r),this.options.multiselect?(o.find(".sugg-label").text(i),o.suggInsertBefore(this.$inputWrapper)):this.$input.suggSetValue(s),r},addCurrentBuffer:function(){var e=t.trim(this.$input.suggGetValue());e!==this.options.placeholder&&""!==e&&(this.add(e),this.$input.suggSetValue(""))},moveSelection:function(t){var e,s=this.$suggList.find(".sugg-item");e=this.$currentItem&&this.$currentItem.length?"down"==t?this.$currentItem.next():this.$currentItem.prev():"down"==t?s.first():s.last();var i=this.publish("BeforeMove",{direction:t,current:this.$currentItem,next:e,cancelable:!0});return i.isDefaultPrevented()?this:(i.current&&i.current.length&&this.deselectItem(i.current),i.next&&i.next.length&&this.selectItem(i.next),this.$currentItem=i.next,this.publish("AfterMove",{direction:t,last:i.current,current:this.$currentItem}),this)},selectItem:function(t){return t.addClass("sugg-selected"),this},deselectItem:function(t){return t.removeClass("sugg-selected"),this},deselectAllItems:function(){return this.$suggList.find(".sugg-item").removeClass("sugg-selected"),this.$currentItem=null,this},suggest:function(t){this._text=t,this.options.dataUrl?this.fetchResults(t):this.handleSuggestions(this.getResults(t))},addData:function(t){var e,s,i;if(t.length>0&&"object"!=typeof t[0])for(e=0,s=t.length;s>e;e++)i={},i[this.options.valueProperty]=""+t[e],this.data.push(i);else this.data=this.data.concat(t);return this},setData:function(t){return this.data=[],this.addData(t),this},getData:function(){return this.data},setFlyDirection:function(t){return"up"==t?(this.$suggListWrapper.suggInsertBefore(this.$box),this.$widget.removeClass("sugg-fly-down").addClass("sugg-fly-up")):"down"==t&&(this.$suggListWrapper.suggInsertAfter(this.$box),this.$widget.addClass("sugg-fly-down").removeClass("sugg-fly-up")),this},focusTag:function(t){return this.unfocusTag(),this.$focusedTag=t.addClass("sugg-focused"),r.keydown(this.removeFocusedTag).click(this.unfocusTag),this},unfocusTag:function(){return r.unbind("keydown",this.removeFocusedTag).unbind("click",this.unfocusTag),this.$focusedTag&&this.$focusedTag.removeClass("sugg-focused"),this.$focusedTag=null,this},removeFocusedTag:function(t){return t&&t.which&&(8==t.which||46==t.which)&&(this.$focusedTag&&this.remove(this.$focusedTag),t.preventDefault()),this.unfocusTag(),this},remove:function(e){var s,i,n,o;if("number"==typeof e.nodeType&&"object"==typeof e.style&&(e=t(e)),e instanceof t)i=e.data("tag-value");else{i=e,e=!1;for(var r=0,u=this.tags.length;u>r;r++)if(i==this.tags[r].getValue()||i==this.tags[r].getLabel()){e=this.tags[r].getElement();break}if(!e)return this}return n=e.data("tag-label"),s=this.publish("BeforeRemove",{tag:e,value:i,label:n,cancelable:!0}),s.isDefaultPrevented()?this:(o=this._spliceTag(s.value),this.options.saveToInput&&this.save(),this.publish("AfterRemove",{tag:e,value:s.value,label:n,removed:o}),this.publish("Change"),this)},findRecord:function(t){return this.searchData(t,this.options.searchProperties)},searchData:function(t,e){var s,i,n,o,r,u=this.getData();if(i=u.length,o=e?e.length:0,0===i||0===o)return!1;if(t=""+t,1==o){if(r=e[0],this.options.caseSensitive){for(s=0;i>s;s++)if(u[s][r]===t)return u[s]}else for(t=t.toLowerCase(),s=0;i>s;s++)if("string"==typeof u[s][r]&&u[s][r].toLowerCase()===t)return u[s]}else if(this.options.caseSensitive){for(s=0;i>s;s++)for(n=0;o>n;n++)if(u[s][e[n]]===t)return u[s]}else for(t=t.toLowerCase(),s=0;i>s;s++)for(n=0;o>n;n++)if("string"==typeof u[s][e[n]]&&u[s][e[n]].toLowerCase()===t)return u[s];return!1},suggestIfNeeded:function(){var t=this.$input.suggGetValue();return t.length>=this.options.minChars?this.suggest(t):this.options.prompt?this.showPrompt():this.closeSuggestBox(),this},showPrompt:function(){return this.$prompt?(this.$suggList.html("").suggAppend(this.$prompt),this.openSuggestBox(),this.$widget.addClass("sugg-prompt-shown"),this):this},showEmptyText:function(){return this.$suggList.html(""),this.options.emptyText?(this.$empty.html(this.options.emptyText).appendTo(this.$suggList),this.openSuggestBox(),this.$widget.addClass("sugg-empty-shown")):this.closeSuggestBox(),this},fetchResults:function(e){this._searchTerm=e;var s={context:this,url:this.options.dataUrl.replace("%s",e)};if("json"==this.options.dataType.toLowerCase())s.dataType="json";else{if("jsonp"!=this.options.dataType.toLowerCase())throw Error('jQuery.Suggester#fetchResults: options.dataType must be "json" or "jsonp".');s.dataType="jsonp",s.url=s.url.replace("%s","?")}var i=this.publish("BeforeAjax",{settings:s,term:e,cancelable:!0});if(i.isDefaultPrevented())return this._afterFetch(i.records||[]),!1;i.settings.beforeSend=this._beforeFetch;var n=t.ajax(i.settings).done(this._afterFetch);return this.publish("AfterAjax",{settings:i.settings,term:i.term,jqXHR:n}),n},abortFetch:function(){return this._jqXHR&&this._jqXHR.abort(),this},handleSuggestions:function(e){if(!e||0===e.length)return this.showEmptyText(),this;var s;this.$suggList.empty();for(var i=0,n=e.length;n>i;i++)s=t(this._formatSuggestion(e[i],this._text)),s.data("tag-record",e[i]),this.$suggList.suggAppend(s);var o=this.publish("BeforeSuggest",{text:this._text,cancelable:!0});return o.isDefaultPrevented()?this:(this.openSuggestBox(),this.publish("AfterSuggest"),this)},isSuggestBoxOpen:function(){return"none"!=this.$suggList.css("display")},openSuggestBox:function(){var e,s,i,n,u,a,h=this;return"absolute"==this.options.suggListPosition&&(s=(o||(o=t(document.body))).offset(),n=this.$box.position(),"up"==this.options.fly?(this.$suggList.css("visibility","hidden").show(),u=n.top-s.top-this.$box.outerHeight()+this.$box.height()-this.$suggList.outerHeight(),this.$suggList.hide().css("visibility","visible")):u=n.top-s.top+this.$box.outerHeight(),a=n.left-s.left,i=this.$box.outerWidth(),this.$suggList.css({top:u+"px",left:a+"px",width:i})),e=this.publish("BeforeOpen",{cancelable:!0}),e.isDefaultPrevented()?this:(this.$widget.addClass("sugg-list-open").removeClass("sugg-prompt-shown").removeClass("sugg-empty-shown"),setTimeout(function(){r.bind("click",h._closeOnOutsideClick)},0),this.$suggList.show(),this.publish("AfterOpen"),this)},closeSuggestBox:function(){r.unbind("click",this._closeOnOutsideClick);var t=this.publish("BeforeClose",{cancelable:!0});return t.isDefaultPrevented()||(this.$suggList.hide(),this.$widget.removeClass("sugg-list-open")),this.publish("AfterClose"),this},focus:function(){return this.$input[0].focus(),this},getResults:function(t){var e,s;t=""+t,e=this.publish("BeforeFilter",{text:t}),this.options.caseSensitive||(s=e.text.toLowerCase());var i,n,o,r,u=this,a=[],h=this.getData(),g=u.options.searchProperties,l=g.length;for(n=0,o=h.length;o>n;n++)if(!(u.options.omitAlreadyChosenItems&&u.getTagIndex(h[n][u.options.valueProperty])>-1)){for(r=0;l>r;r++)if(i=""+(h[n][g[r]]||""),u.options.caseSensitive||(i=i.toLowerCase()),"anywhere"==u.options.matchAt&&i.indexOf(s)>-1||i.indexOf(s)==u.options.matchAt||"end"==u.options.matchAt&&i.indexOf(s)==i.length-s-length){a.push(h[n]);break}if(u.options.maxSuggestions>0&&a.length>=u.options.maxSuggestions)break}return e=this.publish("AfterFilter",{text:e.text,results:a}),e.results},clear:function(){for(var t=0,e=this.tags.length;e>t;t++)this.tags[t].getHidden().remove(),this.tags[t].getElement().remove();return this.tags=[],this.options.saveToInput&&this.save(),this.publish("Change"),this},getTags:function(){return Array.prototype.slice.call(this.tags)},eachTag:function(e){return t.each(this.getTags(),e),this},serialize:function(){for(var t=[],e=0,s=this.tags.length;s>e;e++)t.push(encodeURIComponent(this.tags[e].getHidden().name)+"="+encodeURIComponent(this.tags[e].getHidden().value));return t.join("&")},getValues:function(){for(var t=[],e=0,s=this.tags.length;s>e;e++)t.push(this.tags[e].getValue());return t},getValue:function(){return this.getValues().join(",")},setValue:function(e){var s,i,n=e.replace(/\\,/g,",").split(/,/g);for(s=0,i=this.tags.length;i>s;s++)this.tags[s].getHidden().remove();for(s=0,i=n.length;i>s;s++)this.add(t.trim(n[s].replace(/\u0001/g,"")));return this.options.saveToInput&&this.save(),this.publish("Change"),this},setTheme:function(t){return this._theme&&this.$widget.removeClass("sugg-theme-"+this._theme),this._theme=t,this.$widget.addClass("sugg-theme-"+this._theme),this},showPlaceholder:function(t){return t="string"==typeof t?t:this.options.placeholder||"",t.length&&(this.$widget.addClass("sugg-placeholder-on"),this.$input.suggSetValue(t),this._updateInputSize()),this},hidePlaceholder:function(){return this.$widget.removeClass("sugg-placeholder-on"),this.$input.suggSetValue(""),this},publish:function(e,s){var i=t.Event(e);return i.target=this,s&&t.extend(i,s),this.trigger(i),i},getInstance:function(){return this},_processOptions:function(e){this.options=t.extend({},t.Suggester.defaultOptions,e),("start"==this.options.matchAt||"beginning"==this.options.matchAt)&&(this.options.matchAt=0)},_render:function(){this.$widget=t(this.options.template),this.publish("BeforeRender",{widget:this.$widget}),this.$box=this.$widget.find(".sugg-box"),this.$tagTemplate=this.$box.find(".sugg-tag").remove(),this.$input=this.$box.find(".sugg-input"),this.$inputWrapper=this.$box.find(".sugg-input-wrapper"),this.$suggListWrapper=this.$widget.find(".sugg-list-wrapper"),this.$suggList=this.$widget.find(".sugg-list"),"absolute"==this.options.suggListPosition&&(this.$suggList.appendTo(document.body),document.body.style.position="relative",this.$suggList.css("position","absolute")),this.$empty=this.$suggList.find(".sugg-empty").html(this.options.emptyText).remove(),this.$prompt=this.$suggList.find(".sugg-prompt").html(this.options.prompt||"").remove(),this.listItemTemplate=this.options.listItemTemplate||this.$suggList.html(),this.$suggList.html(""),this.setFlyDirection(this.options.fly),this.$widget.suggInsertBefore(this.$originalInput.hide()),this._handleStartValue(),0===this.options.minChars&&(this.options.inputSize="",this.$input.width(this.$box.width()-parseFloat(this.$inputWrapper.css("paddingLeft"))-parseFloat(this.$inputWrapper.css("paddingRight"))-parseFloat(this.$inputWrapper.css("marginLeft"))-parseFloat(this.$inputWrapper.css("marginRight"))-parseFloat(this.$inputWrapper.css("borderLeftWidth"))-parseFloat(this.$inputWrapper.css("borderRightWidth"))-parseFloat(this.$input.css("paddingLeft"))-parseFloat(this.$input.css("paddingRight"))-parseFloat(this.$input.css("marginLeft"))-parseFloat(this.$input.css("marginRight"))-parseFloat(this.$input.css("borderLeftWidth"))-parseFloat(this.$input.css("borderRightWidth")))),this.options.theme&&this.setTheme(this.options.theme),this.publish("AfterRender",{widget:this.$widget})},_handleStartValue:function(){var t=this.$originalInput.suggGetValue();t?(this.hidePlaceholder(),this.setValue(t)):0===this.tags.length?this.showPlaceholder():this.hidePlaceholder()},_setupListeners:function(){this.unfocusTag=t.proxy(this,"unfocusTag"),this.removeFocusedTag=t.proxy(this,"removeFocusedTag"),this.suggestIfNeeded=t.proxy(this,"suggestIfNeeded"),this._closeOnOutsideClick=t.proxy(this,"_closeOnOutsideClick"),this.$input.focus(t.proxy(this,"_onInputFocus")),this.$input.blur(t.proxy(this,"_onInputBlur")),this.$box.delegate(".sugg-remove","click",t.proxy(this,"_onTagRemoveClick")),this.$box.delegate(".sugg-tag","click",t.proxy(this,"_onTagClick")),this.$suggList.mouseover(t.proxy(this,"_onListMouseover")),this.$suggList.click(t.proxy(this,"_onListClick")),this.$box.click(t.proxy(this,"_onBoxClick")),t.Suggester.quickBind(this.$input.get(0),"keydown",t.proxy(this,"_onKeydown")),this.$input.bind("cut delete",t.proxy(this,"_onCutDelete")),this.$input.bind("paste",t.proxy(this,"_onPaste")),this.$form.submit(t.proxy(this,"_onSubmit"))},_onInputFocus:function(){this.$widget.addClass("sugg-active"),this.hidePlaceholder();var t=this.$input.suggGetValue();this.unfocusTag(),0===this.options.minChars&&this.data.length>0?this.handleSuggestions(this.options.maxSuggestions>0?this.data.slice(0,this.options.maxSuggestions):this.data):t===this.options.placeholder?this._updateInputSize():""===t&!!this.options.prompt&&this.showPrompt()},_onInputBlur:function(){var e=t.trim(this.$input.suggGetValue());if(this.options.placeholder&&""===e)0===this.tags.length&&this.showPlaceholder();else if(""!==e&&this.options.addOnBlur){var s=this;this._onInputBlurTimeout=setTimeout(function(){s.add(e),s.$input.suggSetValue("")},500)}this.$widget.removeClass("sugg-active")},_onTagRemoveClick:function(e){this.unfocusTag(),e.preventDefault(),e.stopImmediatePropagation();var s=t(e.target).parents(".sugg-tag");this.remove(s)},_onTagClick:function(e){var s=t(e.target);s.hasClass("sugg-tag")||(s=s.parents(".sugg-tag")),e.stopImmediatePropagation(),this.focusTag(s)},_onListMouseover:function(e){var s=t(e.target);s.hasClass("sugg-list")||(s.hasClass("sugg-item")||(s=s.parents(".sugg-item")),s.hasClass("sugg-item")&&(this.deselectAllItems(),this.selectItem(s),this.$currentItem=s))},_onListClick:function(e){clearTimeout(this._onInputBlurTimeout);var s=t(e.target);if(!s.hasClass("sugg-list")&&(s.hasClass("sugg-item")||(s=s.parents(".sugg-item")),s.hasClass("sugg-item"))){var i=s.data("tag-record");this.add(i[this.options.valueProperty],i[this.options.labelProperty],s),this.closeSuggestBox(),this.options.multiselect&&(this.$input.suggSetValue(""),this._updateInputSize(),this.focus())}},_onBoxClick:function(t){t.target==this.$box[0]&&(this.unfocusTag(),this.focus())},_onKeydown:function(t){var e=this.publish("BeforeHandleKey",{keydown:t,cancelable:!0});if(!e.isDefaultPrevented()){var s=t.metaKey||t.shiftKey||t.altKey;s?this._key_other(t):38==t.which?this._key_UP(t):40==t.which?this._key_DOWN(t):8==t.which?this._key_BACKSPACE(t):this.options.addOnTab&&9==t.which||this.options.addOnComma&&188==t.which||this.options.addOnSemicolon&&59==t.which?this._key_TAB_COMMA(t):27==t.which?this._key_ESC(t):13==t.which?this._key_ENTER(t):this._key_other(t),this._updateInputSize(),this.publish("AfterHandleKey",{keydown:t})}},_onCutDelete:function(){setTimeout(t.proxy(this._updateInputSize,this),0)},_onPaste:function(e){var s,i,n,o,r=[],u=[];try{s=e.originalEvent.clipboardData.getData("text/plain")}catch(a){s=window.clipboardData.getData("Text")}if(e.preventDefault(),this.options.addOnTab&&(r=s.split("	")),2>r.length&&this.options.addOnSemicolon&&(r=s.split(";")),2>r.length&&this.options.addOnComma&&(r=s.split(",")),r.length>0)for(n=0,o=r.length;o>n;n++)i=t.trim(r[n]),""!==i&&u.push(i);var h=this.publish("BeforePaste",{event:e,value:s,tags:u});if(!h.isDefaultPrevented()){if(2>h.tags.length)return this.$input.suggSetValue(this.$input.suggGetValue()+s),this._updateInputSize(),void 0;for(e.preventDefault(),n=0,o=h.tags.length;o>n;n++)this.add(u[n]);this.publish("AfterPaste",{event:e,value:s,tags:h.tags})}},_key_UP:function(t){t.preventDefault(),this.unfocusTag(),this.moveSelection("up")},_key_DOWN:function(t){t.preventDefault(),this.unfocusTag(),this.isSuggestBoxOpen()&&this.moveSelection("down")},_key_BACKSPACE:function(t){var e;this.$currentItem=null,this._isCursorAtStart()?(this.options.multiselect&&this.tags.length>0&&(t.preventDefault(),e=this.tags[this.tags.length-1].$tag,this.$focusedTag&&e&&this.$focusedTag[0]==e[0]?this.remove(e):e&&(this.$focusedTag=e,e.addClass("sugg-focused"))),this.closeSuggestBox()):this._key_other(t)},_key_TAB_COMMA:function(t){(9!=t.which||""!==this.$input.suggGetValue())&&(t.preventDefault(),""!==this.$input.suggGetValue()&&(this.$currentItem=null,this.add(this.$input.suggGetValue()),this.options.multiselect&&this.$input.suggSetValue(""),this.closeSuggestBox()))},_key_ESC:function(){this.closeSuggestBox()},_key_ENTER:function(t){if(this.$currentItem){var e=this.$currentItem.data("tag-record");this.add(e[this.options.valueProperty],e[this.options.labelProperty],this.$currentItem),this.options.multiselect&&this.$input.suggSetValue(""),this.closeSuggestBox(),this.$currentItem=null}this.options.submitOnEnter||t.preventDefault()},_key_other:function(){this.abortFetch(),clearTimeout(this.timeoutHandle),this.$currentItem=null,this.unfocusTag(),this.timeoutHandle=setTimeout(this.suggestIfNeeded,this.options.keyDelay||0)},_onSubmit:function(t){var e=this.publish("BeforeSubmit",{event:t,form:this.$form,cancelable:!0});return e.isDefaultPrevented()?(t.preventDefault(),void 0):(this.options.addOnSubmit&&""!==this.$input.suggGetValue()&&(this.$currentItem=null,this.add(this.$input.suggGetValue()),this.options.multiselect&&this.$input.suggSetValue(""),this.closeSuggestBox()),void 0)},_beforeFetch:function(t){this._jqXHR=t;var e=this.publish("BeforeFetch",{jqXHR:this._jqXHR,term:this._searchTerm,cancelable:!0});e.isDefaultPrevented()&&this.abortFetch()},_afterFetch:function(t){var e=this.publish("AfterFetch",{jqXHR:this._jqXHR,records:t,term:this._searchTerm,cancelable:!0});this._jqXHR=null,e.isDefaultPrevented()||this.handleSuggestions(e.records)},_closeOnOutsideClick:function(e){var s=t(e.target);s.parents(".sugg-widget")[0]!=this.$widget[0]&&this.closeSuggestBox()},_formatSuggestion:function(t,e){var s,i,n,o,r;return s=this.publish("BeforeFormat",{record:t,substr:e,html:""}),""===s.html&&(i=this.options,n=t[i.valueProperty],o=i.caseSensitive?s.substr:RegExp("("+s.substr+")","i"),r=i.caseSensitive?s.substr:"$1",s.html=this.listItemTemplate.replace(/\{record\.(.+?)\}/g,function(t,e){var n=s.record[e];return"string"==typeof n||n?(e==i.valueProperty&&i.hightlightSubstring&&(n=n.replace(o,'<strong class="sugg-match">'+r+"</strong>")),n):""})),s=this.publish("AfterFormat",{record:s.record,substr:s.substr,html:s.html}),s.html},_updateInputSize:function(){"auto"==this.options.inputSize&&this.$input.prop("size",this.$input.suggGetValue().length+2)},save:function(){for(var t,e=this.$originalInput.suggGetValue(),s=[],i=0,n=this.tags.length;n>i;i++)s.push(this.tags[i].getValue().replace(/,/g,"\\,"));t=s.join(",");var o=this.publish("BeforeSave",{cancelable:!0,oldValue:e,newValue:t});if(o.isDefaultPrevented())return e;try{this.$originalInput.get(0).value=o.newValue}catch(r){}return this.publish("AfterSave",{oldValue:e,newValue:o.newValue}),o.newValue},_spliceTag:function(t){var e=this.getTagIndex(t);return e>-1?this._spliceTagByIdx(e):void 0},_spliceTagByIdx:function(t){for(var e=this.tags[t],s=[],i=0,n=0,o=this.tags.length;o>n;n++)n===t?(this.tags[n].getHidden().remove(),this.tags[n].getElement().remove()):(this.tags[n].index=i++,s.push(this.tags[n]));return this.tags=s,e},getTagIndex:function(t){var e,s,i=-1;for(e=0,s=this.tags.length;s>e;e++)if(this.tags[e].value==t){i=e;break}return i},_setupPubsub:function(){this.pubsub=t(this),this.on=t.proxy(this.pubsub,"on"),this.off=t.proxy(this.pubsub,"off"),this.one=t.proxy(this.pubsub,"one"),this.bind=t.proxy(this.pubsub,"bind"),this.unbind=t.proxy(this.pubsub,"unbind"),this.trigger=t.proxy(this.pubsub,"trigger"),this.triggerHandler=t.proxy(this.pubsub,"triggerHandler");for(var e in this.options)e.match(/^on[A-Z0-9]/)&&"function"==typeof this.options[e]&&this.bind(e.slice(2),this.options[e])},_isCursorAtStart:function(){var t=s(this.$input[0]),e=i(this.$input[0]);return 0===t&&0===e}},t.Suggester.version="1.3.0",t.Suggester.doSubclass={},t.Suggester.instances=[],t.Suggester.addData=function(e){for(var s=0,i=t.Suggester.instances.length;i>s;s++)t.Suggester.instances[s].addData(e);return this},t.Suggester.quickBind=document.addEventListener?function(t,e,s){t.addEventListener(e,s,!1)}:function(t,e,s){t.attachEvent("on"+e,function(e){e=e||window.event,e.preventDefault=function(){e.returnValue=!1},s.call(t,e)})},t.Suggester.subclass=function(e,s){var i=function(){this.initialize.apply(this,Array.prototype.slice.call(arguments))};return i.prototype=new t.Suggester(t.Suggester.doSubclass),i.prototype.callParent=function(e){t.Suggester.prototype[e].apply(this,e,Array.prototype.slice.call(arguments,1))},i.prototype.applyParent=function(e,s){t.Suggester.prototype[e].apply(this,e,s)},t.extend(i.prototype,s||{}),n(e,i),i},n("suggester",t.Suggester),t.Suggester.Tag=function(){this.initialize.apply(this,Array.prototype.slice.call(arguments))},t.Suggester.Tag.prototype={initialize:function(e){t.extend(this,e)},getWidget:function(){return this.suggester},remove:function(){return this.suggester.remove(this.value),this},getIndex:function(){return this.index},getValue:function(){return this.value},setValue:function(t){return this.value=t,this.$hidden.suggSetValue(t),this.suggester.options.saveToInput&&this.suggester.save(),this.suggester.publish("Change"),this},getLabel:function(){return this.label},setLabel:function(t){return this.label=t,this.$tag.text(t),this},getHidden:function(){return this.$hidden},getElement:function(){return this.$tag},getRecord:function(){return this.record}}});